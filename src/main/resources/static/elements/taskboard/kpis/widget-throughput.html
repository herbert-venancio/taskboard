<!--
  [LICENSE]
  Taskboard
  ---
  Copyright (C) 2015 - 2018 Objective Solutions
  ---
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="widget-throughput"> 
  <template>

    <style>
    </style>

    <widget-wrap title="Throughput" is-ready="{{isReady}}" tags="{{tags}}"
        error-message="{{errorMessage}}" options="{{options}}"
        chart="{{chart}}">
      <div id="throughput" class="tb-chart"></div>
    </widget-wrap> 
    <modal-wrap class="filters-modal" title="Filters">
      <modal-wrap-content>
        <h3 class="tb-label">Issue Types</h3>
        <div class="config-slot-0 dc-chart--no-float"></div>
      </modal-wrap-content>
      <modal-wrap-footer> 
        <tb-button button=[[_btFilterClose]]></tb-button>
      </modal-wrap-footer>
    </modal-wrap>
    <modal-wrap class="settings-modal" title="Settings">
      <modal-wrap-content>
        <h3 class="tb-label">Level</h3>
        <div>
          <label id="labelLevel"></label>
          <paper-radio-group class="radio-group" selected="{{settingIssueLevel}}"
              aria-labelledby="labelLevel"> 
            <paper-radio-button name="Demand">Demand</paper-radio-button> 
            <paper-radio-button name="Feature">Feature</paper-radio-button> 
            <paper-radio-button name="Subtask">Subtask</paper-radio-button> 
          </paper-radio-group>
        </div>
      </modal-wrap-content> 
      <modal-wrap-footer> 
        <tb-button button="[[_btLevelSave]]"></tb-button> 
      </modal-wrap-footer> 
    </modal-wrap> 
  </template>
  <script>
        (function () {
            Polymer({
                is: 'widget-throughput',
                properties: {
                    selectedProjectKey: {
                        type: String,
                        notify: true,
                        value: '',
                        observer: '_onProjectSelected'
                    },
                    tags: {
                        type: Array
                    },
                    isReady: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    errorMessage: {
                        type: String,
                        notify: true
                    },
                    chart: {
                        type: Object,
                        notify: true,
                        value: null
                    },
                    options: {
                        type: Array,
                        value: null
                    },
                    settingIssueLevel: {
                        type: String,
                        notify: true,
                        value: 'Subtask'
                    },
                    localStorageLevelItemName: {
                        type: String,
                        computed: 'computeLocalStorageLevelItemName(selectedProjectKey)'
                    },
                    _btFilterClose: {
                        type: Object,
                        value: null
                    },
                    _btLevelSave: {
                        type: Object,
                        value: null
                    }
                },
        
                _onProjectSelected: function (newSelectedProjectKey, oldSelectedProjectKey) {
                    this.reloadChart();
                },

                _getSavedLevel: function () {
                    return window.localStorage.getItem(this.localStorageLevelItemName) || 'Subtask';
                },

                computeLocalStorageLevelItemName: function (selectedProjectKey) {
                    return `dashboard.throughput-chart.${selectedProjectKey}.level`;
                },

                ready: function () {
                    dcUtils.registerOptions(this);
                    this._btFilterClose = ButtonBuilder('Ok').onClick(() => this.$$('.filters-modal').close()).build();
                    this._btLevelSave = ButtonBuilder('Save').onClick(() => {
                        let savedLevel = this._getSavedLevel();
                        if (savedLevel === this.settingIssueLevel) {
                            this.$$('.settings-modal').close();
                            return;
                        }
                        window.localStorage.setItem(this.localStorageLevelItemName, this.settingIssueLevel);
                        this.$$('.settings-modal').close();
                        this.reloadChart();
                    }).build();
                },

                reset: function () {
                    this.isReady = false;
                    this.errorMessage = '';
                    this.set('options.0.cssClasses', '');
                    this.set('options.0.hidden', true);
                    if (this.xhr) {
                        this.xhr.abort();
                        this.xhr = null;
                    }
                    if (this.chart) {
                        dcDateRangeChartsService.deregisterChartInRange(this.chart);
                        dc.deregisterChart(this.chart);
                        this.chart = null;
                    }
                },
                handleError: function (error, data) {
                    if (error) {
                        this.errorMessage = error.responseText;
                        return true;
                    }
                    if (!data.rows.length) {
                        this.errorMessage = 'Throughput has no data';
                        return true;
                    }
                    return false;
                },
        
                reloadChart: function () {
                    this.reset();
                    const savedLevel = this._getSavedLevel();
                    const timezone = taskboard.getTimeZoneIdFromBrowser();
                    this.tags = [savedLevel];
                    const url = `/api/projects/${this.selectedProjectKey}/followup/throughput?level=${savedLevel}&timezone=${timezone}`;
                    this.xhr = d3.json(url, (error, data) => {
                        if (this.handleError(error, data)) {
                            return;
                        }
                        data = data.rows;
        
                        const plotData = this.prepareData(data);
                        this.issueListFilter = this.createIssueListFilter(plotData.ndx);
                        this.chart = this.createChart(plotData);
                        dcDateRangeChartsService.registerChartInRangeAndRender(this.chart);
                        this.isReady = true;
                    });
                },

                prepareData: function (data) {
                    // parsing data from controller
                    data.forEach((item) => {
                        item.date = new Date(Number(item.date));
                        item.throughput = Number(item.count);
                        // clean-up
                        delete item.count;
                    });
                    const [startDate, endDate] = d3.extent(data, (item) => item.date);
                    const ndx = dc.crossfilter(data);
                    // Date as dimension
                    const dimension = ndx.dimension((item) => item.date);
                    // extract issue types into a array without repetition
                    const issueTypes = [...new Set(data.map((item) => item.issueType))];
                    const dateGroup = dimension.group();
                    dcUtils.groupChartDataByGroupKey(dateGroup, 'issueType', 'throughput');
                    return Object.freeze({
                        ndx: ndx,
                        dimension: dimension,
                        startDate: startDate,
                        endDate: endDate,
                        issueTypes: issueTypes,
                        dateGroup: dateGroup
                    });
                },

                createIssueListFilter: function (ndx) {
                    this.set('options.0.hidden', false);
                    const div = this.$$('.config-slot-0');
                    const typeDimension = ndx.dimension((item) => item.issueType);
                    const list = dcUtils.createPaperListFilter(div, typeDimension, '-none-', 'All Issues');
                    list.render();
                    list.on('filtered', () => {
                        const className = list.isAllSelected() ? '' : 'widget__button_highlighted';
                        this.set('options.0.cssClasses', className);
                    });
                    return list;
                },

                createChart: function (plotData) {
                    const chart = dc.barChart('#throughput');
                    dcUtils.configureDefaultStackedChart(chart);
                    dcUtils.insertPlotDataIntoChart(chart, plotData, 'issueTypes');
                    // present legends in reverse order
                    dcUtils.reverseLegendOrder(chart);
                    dcUtils.setupChartDateTicks(chart, plotData.startDate, plotData.endDate, 12);
                    return chart;
                }
            });
        })();
  </script> 
</dom-module>
