<!--
  [LICENSE]
  Taskboard
  ---
  Copyright (C) 2015 - 2018 Objective Solutions
  ---
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="widget-wip"> 
  <template>

    <style>
        .widget__body {
            display: flex;
        }
        #wip {
            display: flex;
            height: 100%;
            width: 100%;
        }
    </style>

    <widget-wrap title="WIP" is-ready="{{isReady}}" tags="{{tags}}"
        error-message="{{errorMessage}}" options="{{options}}"
        highcharts-chart="{{chart}}">
      <div id="wip" class="tb-chart"></div>
    </widget-wrap> 
    <modal-wrap class="filters-modal" title="Filters">
      <modal-wrap-content>
        <h3 class="tb-label">Issue Types</h3>
        <div id="issueTypes" class="config-slot-0 dc-chart--no-float"></div>
      </modal-wrap-content>
      <modal-wrap-footer> 
        <tb-button button=[[_btFilterClose]]></tb-button>
      </modal-wrap-footer>
    </modal-wrap>
    <modal-wrap class="settings-modal" title="Settings">
      <modal-wrap-content>
        <h3 class="tb-label">Level</h3>
        <div>
          <label id="labelLevel"></label>
          <paper-radio-group class="radio-group" selected="{{settingIssueLevel}}"
              aria-labelledby="labelLevel"> 
            <paper-radio-button name="Demand">Demand</paper-radio-button> 
            <paper-radio-button name="Feature">Feature</paper-radio-button> 
            <paper-radio-button name="Subtask">Subtask</paper-radio-button> 
          </paper-radio-group>
        </div>
      </modal-wrap-content> 
      <modal-wrap-footer> 
        <tb-button button="[[_btLevelSave]]"></tb-button> 
      </modal-wrap-footer> 
    </modal-wrap> 
  </template>
  <script>
        (function () {
            Polymer({
                is: 'widget-wip',

                properties: {
                    selectedProjectKey: {
                        type: String,
                        notify: true,
                        value: '',
                        observer: '_onProjectSelected'
                    },
                    tags: {
                        type: Array
                    },
                    isReady: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    errorMessage: {
                        type: String,
                        notify: true
                    },
                    chart: {
                        type: Object,
                        notify: true,
                        value: null
                    },
                    options: {
                        type: Array,
                        value: null
                    },
                    settingIssueLevel: {
                        type: String,
                        notify: true,
                        value: 'Subtask'
                    },
                    localStorageLevelItemName: {
                        type: String,
                        computed: 'computeLocalStorageLevelItemName(selectedProjectKey)'
                    },
                    plotData: {
                        type: Object,
                        value: null
                    },
                    _btFilterClose: {
                        type: Object,
                        value: null
                    },
                    _btLevelSave: {
                        type: Object,
                        value: null
                    }
                },

                _onProjectSelected: function (newSelectedProjectKey, previousSelectedProjectKey) {
                    if (newSelectedProjectKey === previousSelectedProjectKey) {
                        return;
                    }
                    this.reloadChart();
                },

                _getSavedLevel: function () {
                    return localStorage.getItem(this.localStorageLevelItemName) || 'Subtask';
                },

                computeLocalStorageLevelItemName: function (selectedProjectKey) {
                    return `dashboard.wip-chart.${selectedProjectKey}.level`;
                },

                ready: function () {
                    dcUtils.registerOptions(this);
                    this._btFilterClose = ButtonBuilder('Ok').onClick(() => this.$$('.filters-modal').close()).build();
                    this._btLevelSave = ButtonBuilder('Ok').onClick(() => {
                        let savedLevel = this._getSavedLevel();
                        if (savedLevel === this.settingIssueLevel) {
                            this.$$('.settings-modal').close();
                            return;
                        }
                        localStorage.setItem(this.localStorageLevelItemName, this.settingIssueLevel);
                        this.$$('.settings-modal').close();
                        this.reloadChart();
                    }).build();
                },

                reset: function () {
                    this.isReady = false;
                    this.errorMessage = '';
                    this.set('options.0.cssClasses', '');
                    this.set('options.0.hidden', true);
                    if (this.xhr) {
                        this.xhr.abort();
                        this.xhr = null;
                    }
                    if (this.chart) {
                        dcDateRangeChartsService.deregisterHighchartsChart(this.chart.title.textStr);
                        this.chart.destroy();
                        this.chart = null;
                    }
                },

                reloadChart: function () {
                    this.reset();
                    const savedLevel = this._getSavedLevel();
                    const timezone = taskboard.getTimeZoneIdFromBrowser();
                    this.tags = [savedLevel];
                    const url = `/api/projects/${this.selectedProjectKey}/followup/wip?level=${savedLevel}&timezone=${timezone}`;
                    this.xhr = $.getJSON(url);
                    this.xhr.done((data) => {
                        data = data.rows;
                        if (!data.length) {
                            this.errorMessage = 'WIP has no data';
                            return;
                        }
                        this.plotData = this.prepareData(data);
                        this.createIssueTypeFilter();
                        this.createChart();
                        this.isReady = true;
                    });
                    this.xhr.fail((error) => {
                        this.errorMessage = error.responseText;
                    });
                },

                prepareData: function (data) {
                    // parsing data from controller
                    data.forEach((item) => {
                        item.date = new Date(Number(item.date));
                        item.date.setHours(0, 0, 0, 0);
                        item.wip = Number(item.average);
                        // clean-up
                        delete item.average;
                    });
                    const issueStatuses = _.chain(data).map((item) => item.issueStatus).unique().value();
                    const issueTypes = _.chain(data).map((item) => item.issueType).unique().value();

                    const startDate = data[0].date;
                    const endDate = data[data.length - 1].date;

                    const ndx = crossfilter(data);
                    // Date as dimension
                    const dateDimension = ndx.dimension((item) => item.date);
                    const typeDimension = ndx.dimension((item) => item.issueType);

                    const dateGroup = dateDimension.group();
                    dcUtils.groupChartDataByGroupKey(dateGroup, 'issueStatus', 'wip');
                    return Object.freeze({
                        ndx: ndx,
                        dateDimension: dateDimension,
                        typeDimension: typeDimension,
                        startDate: startDate,
                        endDate: endDate,
                        issueStatuses: issueStatuses,
                        issueTypes: issueTypes,
                        dateGroup: dateGroup
                    });
                },

                createIssueTypeFilter: function () {
                    this.set('options.0.hidden', false);
                    const div = this.$.issueTypes;
                    ChartUtils.createIssueTypeFilter(div, this.plotData.issueTypes, () => {
                        const checkboxes = this.querySelectorAll('input[name=issueType]');
                        const selectedTypes = Array.from(checkboxes).filter((cb) => cb.checked).map((cb) => cb.value);
                        this.plotData.typeDimension.filterFunction((issueType) => selectedTypes.includes(issueType));
                        const toggleAllCheckbox = this.querySelector('input[name=allTypesToggle]');
                        this.set('options.0.cssClasses', toggleAllCheckbox.checked ? '' : 'widget__button_highlighted');
                        this.createChart();
                    });
                },

                createChart: function () {
                    const dataGroupedByDate = this.plotData.dateGroup.all();
                    const series = new Map();
                    const oneWeekInMillis = 7 * 24 * 3600 * 1000;
                    this.plotData.issueStatuses.forEach((status) => {
                        series.set(status, {
                            name: status,
                            data: [],
                            pointStart: this.plotData.startDate.getTime(),
                            pointInterval: oneWeekInMillis
                        });
                    });
                    dataGroupedByDate.forEach((item) => {
                        this.plotData.issueStatuses.forEach((status) => {
                            const wipAvg = Number(item.value[status].toFixed(5));
                            series.get(status).data.push(wipAvg);
                        });
                    });
                    const seriesPlot = [...series.values()];
                    const builder = new WeeklyChartBuilder('wip')
                        .withTitle('WIP')
                        .withChartType('column')
                        .withTooltipNumberOfDecimals(2)
                        .withSeriesData(seriesPlot);
                    this.chart = builder.build();
                    dcDateRangeChartsService.registerHighchartsChart(this.chart.title.textStr, this.chart);
                    dcDateRangeChartsService.applySelection(this.chart.title.textStr);
                }
            });
        })();
    </script> 
</dom-module>