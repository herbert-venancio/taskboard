<!--
  [LICENSE]
  Taskboard
  - - -
  Copyright (C) 2015 - 2016 Objective Solutions
  - - -
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="fields-required-modal">

    <template>

        <style>
            .content-row {
                width: auto;
                display: flex;
            }

            .column-block {
                display: table-cell;
                padding-left: 5px;
                padding-right: 5px;
                min-height: auto;
            }

            .input-fields {
                border-radius: 3px;
                height: 30px;
                width: 470px;
                border: none;
                background: #E6E3E3;
                box-shadow: inset 1px 1px 1px #ABABAF;
                margin-top: 7px;
            }

            textarea {
                max-width: 470px;
                max-height: 400px;
            }

            .error-message {
                white-space: pre;
                margin-left: 10px;
                color: red;
                font-weight: bold;
            }

            .sub-header {
                font-size: 13px;
                font-weight: 500;
                text-align: left;
            }

            paper-menu {
                right: 43.5%;
                margin-top: 40px;
                position: fixed;
            }

            .required {
                color: red
            }
        </style>

        <modal-wrap id="fieldsModal"
                    title="[[action]]"
                    on-close-clicked="closed"
                    >

            <modal-wrap-content>
                <template is="dom-if" if="{{hasRecords(fields)}}">
                    <template is="dom-repeat" items="{{fields}}" as="field">
                        <div class="content-row">
                            <div class="column-block">
                                <span class="required">* </span>
                                <span class="sub-header">[[field.name]]: </span>
                                <br/>
                                <template is="dom-if" if="{{!isTextArea(field.type)}}">
                                    <input is="iron-input" id$="{{field.name}}" class="input-fields" type="text" required value="{{getValue(field.id)}}"/>
                                </template>
                                <template is="dom-if" if="{{isTextArea(field.type)}}">
                                    <textarea id$="{{field.name}}" class="input-fields" required>{{getValue(field.id)}}</textarea>
                                </template>
                                <template is="dom-if" if="{{errorMessage}}">
                                    <br/>
                                    <span class="error-message">{{field.name}} Required</span>
                                </template>
                            </div>
                        </div>
                    </template>
                </template>
            </modal-wrap-content>

            <modal-wrap-footer>
                <tb-button button="[[_btAction]]"></tb-button>
            </modal-wrap-footer>

        </modal-wrap>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'fields-required-modal',

                properties: {
                    fields: {
                        type: Object
                    },

                    action:{
                        type:String
                    },

                    issue:{
                        type:Object,
                    },

                    callback: {
                        type: Object
                    },

                    errorMessage: {
                        type:Boolean,
                    },

                    _btAction: {
                        type: Object,
                        value: function () { return {} }
                    }
                },

                openDialog: function(fields, action, issue, callback) {
                    this.issue = issue;
                    $(this.$.fieldsModal).css('background-color', issue.color);
                    this.fields = fields;
                    this.callback = callback;
                    this.action = action;
                    this.$.fieldsModal.open();
                    setTimeout(function() { 
                        $(this.$$(".input-fields")).focus();
                    }.bind(this),10);

                    var btAction = ButtonBuilder(this.action).id("action-button").onClick(this.confirmed.bind(this)).build();
                    this.set('_btAction', btAction);
                },

                hasRecords: function(records) {
                    return records && records.length > 0;
                },

                isTextArea: function(type) {
                    return type == TYPE_FIELD.TEXTAREA;
                },

                getValue: function(id) {
                    return this.issue[id];
                },

                clearProperties: function() {
                    this.$.fieldsModal.close();
                    this.action = null;
                    this.fields = [];
                    this.issue = [];
                    this.callback = [];
                    this.errorMessage = null;
                    this.clearFieldsValues();
                },

                clearFieldsValues: function() {
                    for (f in this.fields) {
                        var fieldName = this.fields[f].name;
                        document.getElementById(fieldName).value = "";
                        document.getElementById(fieldName).selected = "";
                    }
                },

                confirmed: function() {
                    var values = this.getValuesFields();
                    for (fv in this.fields)
                        this.errorMessage = this.fields[fv].required ? true : false;

                    if (this.errorMessage)
                        return;

                    copyProperties(this.issue, values);
                    this.callback(this.issue);
                    this.clearProperties();
                },
                
                closed: function() {
                    this.fire("close-clicked");
                },

                getValuesFields: function() {
                    var jsonCustomField = {};
                    var jsonField = {};

                    for (f in this.fields) {
                        var idField = this.fields[f].id;
                        var nameField = this.fields[f].name;
                        var valueField = document.getElementById(nameField).value;
                        var selectedField = document.getElementById(nameField).selected;
                        this.fields[f].required = false;
                        var isCustomField = idField.indexOf("customfield") > -1;

                        if (this.isValidValue(valueField)) {
                            if (isCustomField)
                                jsonCustomField[idField] = valueField;
                            else
                                jsonField[idField] = valueField;
                        }
                        else if (this.isValidValue(selectedField)) {
                            if (isCustomField)
                                jsonCustomField[idField] = selectedField;
                            else
                                jsonField[idField] = selectedField;
                        }
                        else
                            this.fields[f].required = true;
                    }
                    return $.extend(jsonField, {"customFields": jsonCustomField});
                },

                isValidValue: function(value) {
                    return value != 0 && value != null;
                }

            });
        })();
    </script>
</dom-module>
