<!--
  [LICENSE]
  Taskboard
  ---
  Copyright (C) 2015 - 2016 Objective Solutions
  ---
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="board-search">

    <style is="custom-style">
        .input-search {
            border-radius: 3px;
            height: 30px;
            width: 65%;
            border: none;
            background: #D7DBF1;
            margin-top: 7px;
        }

        .dropdown-release {
            float: right;
            width: 35%;
        }

        paper-dropdown-menu.custom {
            width: 80%;
            margin-left: 10px;
            margin-top: 5px;
            --paper-input-container-underline: { display: none; };
            --paper-input-container-label: { font-size: 14px; };
            --paper-input-container-input: { font-size: 14px; };
         }

         paper-listbox {
             background: #D7DBF1;
             border-radius: 3px;
             padding: 0;
         }

         paper-item {
            --paper-item-min-height: 30px;
            font-size: 14px;
         }

         paper-icon-button {
            float: right;
            padding: 0;
            width: 15px;
            height: 15px;
            color: #D7DBF1;
            margin-top: 14px;
            position: absolute;
         }
    </style>

    <template>
        <iron-signals on-iron-signal-search-filter-reset="searchReset"></iron-signals>
        <input id="searchIssues" class="input-search" value="{{query::input}}" type="search"
               placeholder="Search Issues" results="5" autocomplete="off"/>
        <template is="dom-if" if="{{hasReleases(releases)}}">
            <div class="dropdown-release">
                <paper-dropdown-menu class="custom" id="searchRelease" label="Release" no-label-float
                                     on-value-changed="searchIssue" on-keydown="searchReleaseOnKeyDown">
                    <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{releaseSelected}}">
                        <template is="dom-repeat" items="{{releases}}" as="itemRelease">
                            <paper-item value="{{itemRelease}}">{{itemRelease}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-icon-button id="clearReleaseButton" icon="clear" on-click="clearRelease" hidden></paper-icon-button>
            </div>
        </template>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'board-search',

                properties: {
                    query: {
                        type: String,
                        notify: true
                    },
                    releaseSelected: {
                        type: String,
                        notify: true
                    },
                    releases: {
                        type: Array,
                        notify: true
                    }
                },

                listeners: {
                    'searchIssues.change': 'searchIssue',
                    'query-changed': 'searchIssue'
                },

                searchIssue: function () {
                    clearReleaseButton.hidden = this.releaseSelected ? false : true;
                    this.fire('iron-signal', {name: 'search-filter-changed',
                                              data: { query: this.query , release: this.releaseSelected }});
                },

                searchReset: function() {
                    this.query = "";
                    this.releaseSelected = "";
                },

                hasReleases: function(releases) {
                    return releases && releases.length > 0;
                },

                clearRelease: function() {
                    this.releaseSelected = "";
                },

                searchReleaseOnKeyDown: function(e) {
                    if (e.key === 'Escape')
                        this.clearRelease();
                }
            });
        })();
    </script>

</dom-module>
