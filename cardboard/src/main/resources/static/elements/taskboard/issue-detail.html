<dom-module id="issue-detail">

    <template>

        <style>
            :host * {
                font-family: 'ptsans-regular', Verdana, Arial, Helvetica, sans-serif;
            }

            .people--separator {
                height: 0px;
                margin-top: 32px;
                border: 1px none #8e8e8e;
                border-top-style: solid;
            }

             /* width */
            ::-webkit-scrollbar {
                width: 10px;
            }

            /* Track */
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            /* Handle */
            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }

            /* Handle on hover */
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
                border-radius: 10px;
            }

            .card-custom {
                background: white;
                width: 100%;
                min-height: 360px;
                padding: 0px;
                margin: 0;
                border-radius: 4px;
                line-height: 18px;
                color: #555;
            }

            .project-title {
                color: #8E8E8E;
            }

            .transitions-row {
                display: flex;
                align-items: center;
                font-size: 12px;
                margin-bottom: 24px;
            }

            .card-header-custom {
                width: 100%;
                font-size: 24px;
                display: flex;
                background-color: #555555;
                padding: 24px;
                border-radius: 4px 4px 0px 0px;
            }

            .card-header-info {
                flex: 1;
            }

            .card-header-breadcrumb {
                font-size: 10px;
                line-height: 14px;
            }

            .arrow {
                margin: 0 5px;
            }

            .card-header-title {
                min-width: initial;
                margin: 0px;
                padding: 0px;
                font-weight: normal;
                display: flex;
            }

            .card-header-title span {
                font-size: 16px;
                line-height: 22px;
                display: block;
                font-family: 'ptsans-caption-bold', Verdana, Arial, Helvetica, sans-serif;
                color: #F5F5F5;
            }

            .sub-content {
                font-size: 14px;
            }

            paper-button {
                margin-bottom: 12px;
                text-transform: none;
            }

            .card-header-buttons {
                padding: 0;
                margin-top: auto;
                margin-bottom: auto;
            }

            .icon-text {
                display: flex;
                align-items: center;
            }

            .icon-text .icon {
                margin-right: 5px;
                filter: initial;
                bottom: initial;
            }

            paper-material, paper-button {
                box-shadow: none !important;
            }

            paper-button.transition-button {
                border-right: 1px solid #E5E5E5;
                border-top: 1px solid #E5E5E5;
                border-bottom: 1px solid #E5E5E5;
                padding: 4px 16px;
                margin: 0px;
                font-size: 12px;
                border-radius: 0px;
                text-transform: none;
                height: 32px;
            }

            paper-button.current-status {
                background-color: #E27323;
                color: white;
                cursor: default;
            }

            paper-button.transition-button:first-of-type {
                border-top-left-radius: 5px !important;
                border-bottom-left-radius: 5px !important;
                border-left: 1px solid #E5E5E5;
            }

            paper-button.transition-button:last-of-type {
                border-top-right-radius: 5px !important;
                border-bottom-right-radius: 5px !important;
            }

            .block-button-container {
                display: flex;
                margin-left: 16px;
                margin-right: 8px;
            }

            .block-button {
                cursor: pointer;
            }

            paper-button[toggles] {
                transition: all 0.3s;
            }

            paper-button[toggles][active] {
                background-color: rgba(0, 0, 0, 0.25);
            }

            #parent-card-name {
                font-weight: 600;
                margin: 0px;
                padding: 0px;
                text-align: left;
                color: #5DAFFF;
            }

            paper-material.subtask-panel {
                display: flex;
                border-bottom: 1px solid #EFEFEF;
                border-top: 1px solid #EFEFEF;
                padding: 8px;
            }
            paper-material.subtask-panel > div {
                display: flex;
                margin-top: auto;
                margin-bottom: auto;
            }
            .subtasks--panel {
                width: 100%;
            }
            .subtask--issue-type {
                width: 48px;
            }
            .subtask--issue-type img {
                margin: auto;
            }
            .subtask--issue-key {
                color: #5DAFFF;
                margin-right: 10px;
            }

            paper-button.subtask-link {
                color: #5DAFFF;
                margin: 0 5px 0 0;
                padding: 0;
                display: inline;
            }

            .subtask--summary {
                flex: 10;
            }

            .subtask--status {
                border-radius: 5px;
                color: white;
                height: 24px;
                font-size: 12px;
                padding-left: 8px;
                padding-right: 8px;
            }
            .subtask--status span {
                display: inline-block;
                margin: auto;
            }

            paper-material.subtask-panel:first-child {
                margin-top: 0;
            }

            .content-box {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 24px;
                margin-bottom: 24px;
            }

            #timetracking_content {
                height: 40px;
            }

            #modal {
                background: white;
                width: 1280px;
                margin: 0;
                display: block;
                border-radius: 5px;
                overflow-x: initial;
                overflow-y: initial;
            }

            .button-close {
                min-width: auto;
                display: inline;
                padding: 0;
                margin: 0;
            }

            .button-close iron-icon {
                width: 14px;
                height: 14px;
                color: #8E8E8E;
            }

            .close-tshirt-bubble {
                min-width: auto;
                display: inline;
                padding: 0;
                margin: 0;
                color: #8E8E8E;
            }

            .close-tshirt-bubble iron-icon {
                width: 10px;
                height: 10px;
            }

            .icon img {
                display: block;
            }

            .icon-small {
                width: 32px;
                height: 32px;
            }

            .description-box {
                width: 100%;
                border: 1px solid #e5e5e5;
                margin-top: 16px;
                border-radius:4px;
                position:relative;
            }

            .description-box .wrapper-edit {
                position:absolute;
                right:0;
                top:0;
                cursor:pointer;
                width: 20px;
                height: 100%;
                border-top-right-radius: 4px;
                border-bottom-right-radius: 4px;
                background-color: #e8e8e8;
                text-align:center;
                display:none;
            }
            
            .description-box:hover .wrapper-edit {
                display:block;
            }
            
            .description-box__field {
                text-align:left;
                resize:none;
                border-top:0;
                border-right:0;
                padding:10px;
                border-bottom:1px solid #E8E8E8;
                border-left:0;
                width:100%;
                height:20vh;
            }

            .description-box__footer {
                padding:16px 24px;
                justify-content:flex-end;
                display:flex;
            }
            
            
            .wrapper-edit iron-icon {
                cursor:pointer;
                color:#8e8e8e;
                width:12px;
                height:12px;
            }
                        
            .description-box__footer paper-button.tb-button__default {
                margin-right:15px;
            }

            .details-row.description-row {
                width: 100%;
                margin:0;
            }
            .description-row--collapsed {
                overflow-y: hidden;
                max-height: 20vh;
                text-overflow: ellipsis;
            }
            .description-row-no-description {
                font-style: italic;
                color: #8e8e8e !important;
            }
            .description-row marked-element {
                padding:0 24px 0 8px;
                width: 100%;
            }

            .descriptionShowMore {
                color: #5DAFFF;
                font-size: 12px;
                margin-top: 10px;
                margin-left: 10px;
                margin-bottom: 8px;
                cursor: pointer;
            }
            .descriptionShowMore iron-icon {
                width: 8px;
                height: 8px;
                margin-bottom: 3px;
                display: inline-block;
            }
            .upsideDown {
                transform: rotate(180deg);
            }

            paper-spinner[aria-hidden=true] {
                display: none;
            }

            .glasspane {
                position: absolute;
                left: 0px;
                width: 100%;
                height: 100%;
                background-color: rgba(197, 202, 233, 0.72);
                z-index: 1000;
                visibility: hidden;
                margin: 0;
                padding: 0;
                cursor: pointer;
            }

            .glasspane span {
                font-size: 24px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100%;
                text-align: center;
                line-height: 30px;
            }

            .visible-glasspane {
                visibility: visible !important;
            }

            .message-box {
                position: absolute;
                bottom: 25px;
                right: 25px;
                min-width: 182px;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 0px 4px;
                border-radius: 5px;
                padding: 8px;
            }
            .message-box--error {
                background: #E72915;
            }

            .message-box--updating {
                background: #E2AE33;
            }

            .message-box__icon {
                flex: 0 0 auto;
                width: 14px;
                height: 14px;
                padding: 0;
                margin-top: auto;
                margin-bottom: auto;
            }

            .message-box__icon[icon="error"] {
                color: white !important;
                width: 20px;
                height: 20px;
            }

            .message-box__message {
                flex: 1;
                margin: 0;
                color: white;
                font-weight: normal;
            }

            .message-box__close {
                flex: 0 0 auto;
                width: 20px;
                height: 20px;
                padding: 0;
                margin-top: auto;
                margin-bottom: auto;
                color: white;
            }

            .tag {
                background-color: #666666;
                font-size: 12px;
                border-radius: 5px;
                color: white;
                padding: 2px 6px;
                display: flex;
                margin-right: 8px;
                white-space: nowrap;
                height: 2em;
                margin-top: 2px;
                margin-bottom: 2px;
            }

            .invalid-assignee {
                background-color: #E2AE33;
            }
            .invalid-assignee .assignee-button {
                color: white !important;
            }
            
            .assignee span {
                display: inline-block;
                margin-right: 2px;
            }
            .add-people-icon {
                width: 9px;
                height: 9px;
                margin: auto 2px;
            }
            .restore-icon {
                width: 9px;
                height: 9px;
                margin: auto 3px;
            }
            #assignToMe {
                margin-right: 8px;
            }

            .people-action-link {
                cursor: pointer;
                color: #5DAFFF;
                font-size: 12px;
                display: flex;
                margin-top: 5px;
                margin-bottom: 5px;
            }

            #restoreTeamButton {
                margin-left: 10px;
            }

            .people-actions {
                display: flex;
                white-space: nowrap;
            }

            .people-action-link span {
                margin: auto;
            }

            .icon-tiny {
                width: 12px;
                height: 12px;
            }

            .remove-button {
                width: 10px;
                height: 10px;
            }

            .assignee-button {
                cursor: pointer;
                color: #8E8E8E;
                margin: auto 2px auto 5px;
            }

            .default-team, .team-by-issue-type {
                background-color: #8e8e8e !important;
                cursor: pointer;
            }

            .default-team iron-icon, .team-by-issue-type iron-icon {
                color: #e5e5e5 !important;
            }

            .parent-team {
                background-color: #8e8e8e !important;
                cursor: pointer;
            }

            .parent-team iron-icon {
                color: #e5e5e5 !important;
            }

            .people-picker {
                display: none;
                background-color: #666666;
                font-size: 12px;
                border-radius: 5px;
                color: white;
                padding-left: 6px;
                padding-right: 6px;
                white-space: nowrap;
                margin: 2px 0px;
                height: 24px;
            }

            .blocked {
                background-color: #FCE196;
                border-radius: 4px;
                padding: 16px;
                display: flex;
            }
            .blocked iron-icon {
                margin-top: auto;
                margin-bottom: auto;
            }
            .blocked span {
                margin-top: auto;
                margin-bottom: auto;
                margin-left: 10px;
                display: inline-block;
            }

            .cancelled {
                background-color: #FCE196;
                border-radius: 4px;
                padding: 16px;
                display: flex;
            }
            .cancelled iron-icon {
                margin-top: auto;
                margin-bottom: auto;
            }
            .cancelled span {
                margin-top: auto;
                margin-bottom: auto;
                margin-left: 10px;
                display: inline-block;
            }

            .panel-parent {
                display: flex;
                height: 60vh;
            }

            .leftPanel {
                width: 64%;
                display: block;
                overflow-y: scroll;
                padding-right: 1em;
            }

            .rightPanel {
                padding-left: 10px;
                width: 36%;
                display: inline-block;
            }

            .subtitle {
                font-size: 16px;
                display: flex;
                margin-top: 32px;
                font-family: 'ptsans-caption-bold', Verdana, Arial, Helvetica, sans-serif;
                line-height: 22px;
            }

            .subtitle:first-of-type {
                margin-top: 0px;
            }

            .subtitle--slot1 {
                flex: 1;
                font-weight: bold;
            }

            .subtasks--title {
                margin-bottom: 12px;
            }

            .tshirtSizesView {
                font-size: 12px;
                color: #5DAFFF;
                display: flex;
            }

            .tshirtSizesView * {
                cursor: pointer;
            }

            .tshirtSizesView label {
                margin-top: auto;
                margin-bottom: auto;
                margin-left: 5px;
            }

            .subsubtitle {
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: bold;
            }

            .details-row {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                margin: 16px 0px;
            }

            .tshirt-bubble {
                display: none;
                border-radius: 5px;
                border: 1px solid #E3E3E3;
                width: 200px;
                position: absolute;
                margin-left: 90px;
                padding: 10px;
                background-color: white;
                z-index: 1000;
                -webkit-box-shadow: 10px 10px 5px 0px rgba(0,0,0,0.15);
                -moz-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.15);
                box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.15);
            }
            
            .tshirt-bubble-arrow {
                background-color: white;
                box-shadow: -1px 1px 1px 0 rgba( 0, 0, 0, .25);
                content: "\00a0";
                display: block;
                height: 10px;
                left: -5px;
                position: absolute;
                top: 50%;
                transform:             rotate( 45deg );
                    -moz-transform:    rotate( 45deg );
                    -ms-transform:     rotate( 45deg );
                    -o-transform:      rotate( 45deg );
                    -webkit-transform: rotate( 45deg );
                width: 10px;
            }

            .tshirt-line {
                border-bottom: 1px solid #E3E3E3;
                font-size: 12px;
                color: #555555;
                display: flex;
                padding-top: 8px;
                padding-bottom: 8px;
            }
            .tshirt-label {
                flex: 1;
            }
            .tshirt-label--header {
                font-size: 14px;
                font-weight: bold;
                padding-top: 0px;
            }
            .details-column {
                flex: 1
            }
            .text {
                font-size: 14px;
            }
            #class-of-service-value {
                border-radius: 5px;
                padding: 4px 6px;
                width: min-content;
                white-space: nowrap;
                display: flex;
            }

            #class-of-service-selector {
                cursor:pointer;
            }

            .hidden-section {
                display: none;
            }
            .button-open-jira {
                min-width: auto;
                padding: 0px 0px 0px 5px;
                margin: 0px 0px 0px 0px;
            }
            .button-open-jira iron-icon {
                width: 16px;
                height: 16px;
                color: #8E8E8E;
                top: -1px;
            }
        </style>
        <style is="custom-property">
            paper-toggle-button {
                --paper-toggle-button-unchecked-bar-color: white;
                --paper-toggle-button-unchecked-bar: {
                    border: 1px solid #aaaaaa
                }
                --paper-toggle-button-checked-bar-color: white;
                --paper-toggle-button-checked-bar: {
                    border: 1px solid #aaaaaa
                }
                --paper-toggle-button-unchecked-button: {
                    box-shadow: none;
                    width: 10px;
                    height: 10px;
                    background-color: #8E8E8E;
                    margin: 5px;
                }
                --paper-toggle-button-checked-button: {
                    background-color: #E27323;
                }
                --paper-toggle-button-unchecked-ink: {
                    display: none;
                }
                --paper-toggle-button-checked-ink: {
                    display: none;
                }
            }
        </style>

        <iron-signals on-iron-signal-issues-updated="updateIssue"></iron-signals>
        <paper-dialog id="modal" with-backdrop modal
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation"
                      on-iron-overlay-opened="_afterOpen"
                      data-status$="{{_modalStatus}}">

            <div id="glasspane-updated" class$="glasspane {{issueChangeStateClass}}" on-tap="refreshIfUpdated">
                <span>This issue has been updated. <br>Click to refresh its contents.</span>
            </div>

            <div id="glasspane-deleted" class$="glasspane {{issueDeleteStateClass}}" on-tap="close">
                <span>This issue has been deleted. <br>Click to close.</span>
            </div>

            <paper-card class="card-custom" on-tap="_cardTapped">

                <div class="card-header-custom">
                    <div class="card-header-info">
                        <div class="card-header-breadcrumb">
                            <span class="project-title">
                                {{item.project}}
                            </span>
                            <template is="dom-if" if="{{item.parent}}">
                                <span class="parent-key">
                                    <span class="arrow">></span>
                                    <paper-button on-tap="changeCard" data-issue-key$="{{item.parent}}" id="parent-card-name">{{item.parent}} {{item.parentSummary}}</paper-button>
                                </span>
                            </template>
                        </div>
                        <div class="card-header-title">
                            <span id="card-name">{{item.issueKey}} {{item.summary}}</span>
                            <paper-button class="button-open-jira" on-tap="openJira" title="Open {{item.issueKey}} on Jira">
                                <iron-icon icon="open-in-new"></iron-icon>
                            </paper-button>
                        </div>
                    </div>
                    <div class="card-header-buttons">
                        <paper-button class="button-close" on-tap="close">
                            <iron-icon icon="taskboard-icons:close"></iron-icon>
                        </paper-button>
                    </div>
                </div>

                <div class="content-box">
                    <div class="transitions-row">
                        <template is="dom-if" if="{{hasRecords(transitions)}}">
                                <template id="issueTransitions" is="dom-repeat" items="{{transitionList(transitions)}}" as="transition">
                                    <template is="dom-if" if="{{transition.id}}">        
                                        <paper-button 
                                            title$="Transition to {{transition.to.name}}"
                                            data-transition-name$='{{transition.name}}' 
                                            data-transition-id$='{{transition.id}}' 
                                            data-transition-to-status-id$='{{transition.to.id}}' raised 
                                            class="transition-button"
                                            on-tap="requestTransition">
                                            {{transition.name}}
                                        </paper-button>
                                    </template>
                                    <template is="dom-if" if="{{!transition.id}}">
                                        <paper-button 
                                            class="transition-button current-status">
                                            {{transition.name}}
                                        </paper-button>
                                    </template>
                                </template>
                        </template>
                        <template is="dom-if" if="{{!hasRecords(transitions)}}">
                            <paper-spinner active="true" alt="Loading..."></paper-spinner>
                        </template>
                        <div class="block-button-container">Block</div>
                        <paper-toggle-button iron-label-target 
                            class="tb-toggle-button block-button" checked="{{blocked}}"
                            on-change="_toggleBlockUnblock" 
                            enabled="{{_canToggleBlockState()}}">
                        </paper-toggle-button>
                    </div>

                    <div class="panel-parent">
                        <div class="leftPanel">
                            <template is="dom-if" if="{{item.blocked}}">
                                <div class="blocked" title="This issue is blocked">
                                    <iron-icon class="icon-small" icon="taskboard-icons:blocked"></iron-icon>
                                    <span>{{item.lastBlockReason}}</span>
                                </div>
                            </template>
                            <template is="dom-if" if="{{item.cancelled}}">
                                <div class="cancelled" title="This issue was cancelled">
                                    <iron-icon class="icon icon-cancelada icon-small" icon="taskboard-icons:cancelled"></iron-icon>
                                    <span>This issue was cancelled. Check jira for more details</span>
                                </div>
                            </template>

                            <div class="subtitle">Details</div>

                            <div class="details-row">
                                <div class="details-column issue-type">
                                    <div class="subsubtitle">Issue type</div>
                                    <div class="icon-text">
                                        <div class="icon">
                                            <img id="issueTypeIcon" src$="{{issue.typeIconUri}}"/>
                                        </div>
                                        <div class="text">
                                            {{getIssueTypeName(item.type)}}
                                        </div>
                                    </div>
                                </div>
                                <div class="details-column">
                                    <div class="subsubtitle">Class of service</div>
                                    
                                    <paper-material id="class-of-service-value" class="sub-content classofservice" style$="background-color:{{item.color}}">
                                        <template is="dom-if" if="{{classOfServicePickerIsVisible}}">
                                            <span id="class-of-service-selector" on-tap="_showClassOfServicePicker"
                                                    data-picker$="classOfServiceSelector">{{item.classOfServiceValue}}</span>
                                            <iron-icon class="icon-tiny assignee-button" icon="taskboard-icons:change-team"
                                                on-tap="_showClassOfServicePicker"
                                                title="Replace {{item.classOfServiceValue}} by another class of service">
                                            </iron-icon>
                                        </template>
                                        
                                        <template is="dom-if" if="{{!classOfServicePickerIsVisible}}">
                                            <span>{{item.classOfServiceValue}}</span>
                                        </template>
                                    </paper-material>
                                    
                                    <class-of-service-picker
                                        id="classOfServiceSelector"
                                        class="people-picker"
                                        options="{{classOfServiceOptions}}""
                                        on-selected-class-of-service = "_changeClassOfService"
                                        on-close-clicked = "_closePicker"
                                        on-tap="_stopPropagation"
                                        >
                                    </class-of-service-picker>

                                </div>
                                <template is="dom-if" if="{{item.release}}">
                                    <div class="details-column">
                                        <div class="subsubtitle">Release</div>
                                        <div class="sub-content release">
                                            <span>{{item.release.name}}</span>
                                        </div>
                                    </div>
                                </template>
                                <template is="dom-if" if="{{item.cardTshirtSize}}">
                                    <div class="details-column">
                                        <div class="subsubtitle">Size</div>
                                        <div class="sub-content">
                                            {{item.cardTshirtSize}}
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div class="subtitle">Description</div>

                            <div class="description-box">
                               <template is="dom-if" if="{{!descriptionIsEditable}}">
                                    <div class$="details-row  description-row {{getDescriptionClass(item)}}">
                                        <marked-element markdown="{{getDescription(item)}}"></marked-element>
                                        <div class="wrapper-edit" on-tap="_openDescriptionEditMode">
                                            <iron-icon class="description-edit" icon="taskboard-icons:edit"></iron-icon>
                                        </div>
                                    </div>
                                    <template is="dom-if" if="{{descriptionTooLong}}">
                                        <div class="descriptionShowMore" on-tap="_toggleShowMoreOrLess">
                                            <iron-icon icon="taskboard-icons:showmore"></iron-icon>
                                            [[showMoreOrLess]]
                                        </div>
                                    </template>
                                </template>

                                <template is="dom-if" if="{{descriptionIsEditable}}">
                                    <textarea class="description-box__field" name="description" id="description" value={{item.description::input}}></textarea>
                                    <div class="description-box__footer">
                                        <paper-button class="tb-button tb-button__default" on-tap="_closeDescriptionEditMode">Cancel</paper-button>
                                        <paper-button class="tb-button tb-button--type_button description--save-button" on-tap="_saveIssueDescription">Save</paper-button>
                                    </div>
                                </template>
                            </div>

                            <template is="dom-if" if="{{canHaveSubtasks}}">
                                <div class="subtitle subtasks--title">
                                    <div class="subtitle--slot1">
                                    [[subtaskHeader(item.type)]] ({{item.subtasks.length}})
                                    </div>
                                    <div class="subtitle--slot2">
                                        <template is="dom-if" if="{{hasMultipleTShirtSizes(item)}}">
                                            <div class="tshirtSizesView" title="Click to see tshirt sizes">
                                                <iron-icon icon="taskboard-icons:view" on-tap="_showTShirtBubble">Ballparks</iron-icon>
                                                <label on-tap="_showTShirtBubble">
                                                    Ballparks
                                                </label>
                                            </div>
                                            <div class="tshirt-bubble" on-tap="_stopPropagation">
                                                <div class="tshirt-bubble-arrow"></div>
                                                <div class="tshirt-line">
                                                    <div class="tshirt-label tshirt-label--header">Ballparks</div>
                                                    <div class="tshirtValue">
                                                    <paper-button class="close-tshirt-bubble" on-tap="_closeTShirtBubble" title="close">
                                                        <iron-icon icon="taskboard-icons:close"></iron-icon>
                                                    </paper-button>
                                                    </div>
                                                </div>
                                                <template is="dom-repeat" items="{{item.subtasksTshirtSizes}}" as="size">
                                                    <div class="tshirt-line">
                                                        <div class="tshirt-label">{{size.name}}</div>
                                                        <div class="tshirtValue">{{size.value}}</div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>

                                    </div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{hasSubtasks}}">
                                <div class="details-row">
                                    <div id="subtasks_content" class="subtasks--panel">
                                        <template is="dom-repeat" items="{{item.subtasks}}" as="subtask">
                                            <paper-material class="subtask-panel" elevation="0">
                                                <div class="subtask--issue-type">
                                                    <img class="icon-tiny" src$="{{subtask.issueTypeUri}}" title$="{{subtask.issueType}}"/>
                                                </div>
                                                <div class="subtask--issue-key">
                                                    <paper-button class="subtask-link" on-tap="changeCard"  data-issue-key$="{{subtask.issueKey}}" id="child-issue-{{index}}">
                                                        {{subtask.issueKey}}
                                                    </paper-button>
                                                </div>
                                                <div class="subtask--summary">
                                                    {{subtask.summary}}
                                                </div>
                                                <div class="subtask--status" style$="background-color: {{subtask.color}}">
                                                    <span>{{subtask.status}}</span>
                                                </div>
                                            </paper-material>
                                        </template>
                                    </div>
                                </div>
                            </template>

                        </div>
                        <div class="rightPanel">
                            <div class="subtitle">People</div>

                            <div id="teamSection" class$="people-section {{determineTeamSectionClass(item)}}">
                                <div class="subsubtitle">Team:</div>
                                <div class="details-row teams">
                                    <template is="dom-repeat" items="{{item.teams}}" as="team" index-as="teamIndex">
                                        <paper-material class$="{{teamClasses(team)}} tag team labelForTeam_{{teamIndex}}"
                                            title="{{titleForTeam(team)}}" data-team$="{{team.name}}">
                                            <span on-tap="_showReplaceTeamPicker"
                                                data-picker$="teamSelector">{{team.name}}</span>

                                            <template is="dom-if" if="{{showReplaceAction(item.teams)}}">
                                                <iron-icon class="icon-tiny assignee-button" icon="taskboard-icons:change-team"
                                                    on-tap="_showReplaceTeamPicker"
                                                    title="Replace {{team.name}} by another team">
                                                </iron-icon>
                                            </template>

                                            <template is="dom-if" if="{{showRemoveAction(item.teams)}}">
                                                <iron-icon class="remove-button assignee-button" icon="taskboard-icons:remove"
                                                    on-tap="removeTeam"
                                                    title="Remove {{team.name}} from this issue">
                                                </iron-icon>
                                            </template>
                                        </paper-material>
                                    </template>
                                    <team-picker id="teamSelector" class="people-picker" on-tap="_stopPropagation" on-selected-team="_addOrReplaceTeam" on-close-clicked="_closePicker"></team-picker>

                                    <div class="people-actions">
                                        <div id="addTeamButton" class="people-action-link" on-tap="_showAddTeamPicker" title="Add a new team to this issue">
                                            <iron-icon class="add-people-icon" icon="taskboard-icons:add-team"></iron-icon>
                                            <span>Team</span>
                                        </div>
                                        <template is="dom-if" if="{{!showReplaceAction(item)}}">
                                            <div id="restoreTeamButton" class="people-action-link" on-tap="_restoreDefaultTeams" title="Restore issue default teams">
                                                <iron-icon class="restore-icon" icon="taskboard-icons:restore"></iron-icon>
                                                <span>Restore default</span>
                                            </div>
                                       </template>
                                   </div>
                                </div>
                            </div>

                            <div class="subsubtitle">Assignees: </div>

                            <div class="details-row assignees">
                                <template is="dom-repeat" items="{{item.assignees}}" as="assignee" index-as="userIndex">
                                    <paper-material class$="assignee tag {{addClassToInvalidTeam(item, assignee)}}" title="{{titleForAssignee(item, assignee)}}"
                                        data-assignee$="{{assignee.name}}">
                                         <span>{{assignee.name}}</span>
                                         <iron-icon class="remove-button assignee-button" icon="taskboard-icons:remove"
                                                on-tap="_removeAssignee"
                                                title="Remove {{assignee.name}} from this issue"></iron-icon>
                                    </paper-material>
                                </template>
                                <div class="people-actions">
                                    <template is="dom-if" if="{{isNotAssignedToMySelf(item)}}">
                                        <div id="assignToMe" class="people-action-link" on-tap="_addMeAsAssignee" title="Add my self">
                                            <iron-icon class="add-people-icon" icon="taskboard-icons:add-team"></iron-icon>
                                            <span>Me</span>
                                        </div>
                                    </template>
                                    <div id="addAssigneeButton" class="people-action-link" on-tap="pickerForAddAssignee" title="Add a new assignee to this issue">
                                        <iron-icon class="add-people-icon" icon="taskboard-icons:add-team"></iron-icon>
                                        <span>Assignee</span>
                                    </div>
                                    <user-picker
                                            id="pickerForAddAssignee"
                                            class="people-picker"
                                            on-selected-user = "_addAssignee"
                                            on-close-clicked = "_closePicker"
                                            on-tap="_stopPropagation"
                                            >
                                    </user-picker>
                                </div>
                            </div>
                            <hr class="people--separator"/>
                            <div class="subtitle">Tracking</div>

                            <template is="dom-if" if="{{_shouldShowCycleTime(cycleTime)}}">
                                <div class="details-row">
                                    <div class="datailsColumn">
                                        <div class="subsubtitle">Cycle Time</div>
                                        <div class="sub-content">
                                            {{cycleTime}} days
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <template is="dom-if" if="{{item.additionalEstimatedHoursField}}">
                                <div class="details-row">
                                    <div class="datailsColumn">
                                        <div class="subsubtitle">{{item.additionalEstimatedHoursField.name}}</div>
                                        <div class="sub-content">
                                            <span>{{item.additionalEstimatedHoursField.value}}</span>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{shouldShowTimetracking}}">
                                <div class="details-row">
                                    <div class="datailsColumn">
                                        <div class="subsubtitle">Effort</div>
                                        <template is="dom-if" if="{{!isUpdating}}">
                                            <div id="timetracking_content" class="sub-content">
                                                <template is="dom-if" if="{{timetracking}}">
                                                    <span class="text">[[timetrackingLabel]]</span>
                                                </template>
                                                <template is="dom-if" if="{{!timetracking}}">
                                                    <paper-spinner active="true" alt="Loading..."></paper-spinner>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{errorMessage}}">
                                <div class="message-box message-box--error">
                                    <paper-icon-button class="message-box__icon" icon="error" title="Error Icon"></paper-icon-button>
                                    <p class="message-box__message">{{errorMessage}}</p>
                                    <paper-icon-button class="message-box__close" icon="close" title="Close error" on-tap="_closeErrorMessage"></paper-icon-button>
                                </div>
                            </template>

                            <template is="dom-if" if="{{isUpdating}}">
                                <div class="message-box message-box--updating">
                                    <paper-spinner class="message-box__icon" active="true" alt="Updating..."></paper-spinner>
                                    <p class="message-box__message">Updating...</p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </paper-card>
        </paper-dialog>
        <transition-required-modal id="transitionRequiredDialog"></transition-required-modal>
        <confirm-modal id="confirmModal"></confirm-modal>
        <fields-required-modal id="fieldsRequiredDialog" on-close-clicked="blockCancelled"></fields-required-modal>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'issue-detail',

                properties: {
                    item: {
                        type: Object,
                        notify: true
                    },

                    timetracking: {
                        type: Object,
                        notify: true
                    },

                    transitions: {
                        type: Array,
                        value: []
                    },

                    subtasks: {
                        type: Object,
                        notify: true
                    },

                    shouldShowTimetracking: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    timetrackingLabel: {
                        type: String,
                        notify: true
                    },

                    hasSubtasks: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    canHaveSubtasks: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    showFieldsRequiredDialog: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    isUpdating: {
                        type: Boolean
                    },

                    errorMessage: {
                        type: String,
                        value: null
                    },

                    canBlock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    canUnblock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    blocked: {
                        type: Boolean
                    },

                    updatedIssue: {
                        type: Object,
                        value: null
                    },

                    issueChangeStateClass: {
                        type: String,
                        value: ''
                    },

                    issueDeleteStateClass: {
                        type: String,
                        value: ''
                    },

                    localStates: {
                        type: Object,
                        notify: true
                    },

                    _modalStatus: {
                        type: String
                    },

                    _modalStatuses: {
                        type: Object,
                        value: {
                            OPENED: 'opened',
                            CLOSED: 'closed'
                        }
                    },

                    descriptionTooLong: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },

                    descriptionIsEditable: {
                        type: Boolean,
                        value: false,
                    },

                    showMoreOrLess: {
                        type: String,
                        notify: true,
                        value: 'Show More'
                    },

                    cycleTime: {
                        type: Object,
                        notify: true
                    },

                    isOpen: {
                        type: Boolean,
                        value: false
                    },

                    classOfServiceOptions: {
                        type: Array,
                        value: [],
                        notify: true
                    },

                    classOfServicePickerIsVisible: {
                        type: Boolean,
                        value: false
                    }
                },

                observers: [
                    '_resizeModal(subtasks, timetracking, isUpdating, errorMessage)',
                    '_updateIssueLocalState(localStates.*)',
                    '_newTeamChosen(newTeam)',
                ],

                attached: function() {
                    var self = this;

                    self.isObserving = false;
                    new MutationObserver(function(mutations) {
                        if (!self.isObserving)
                            return;
                        mutations.forEach(function(mutation) {
                           if (mutation.type === 'characterData')
                               flash($(mutation.target.parentElement), 'yellow')
                           else
                               flash($(mutation.target), 'yellow')
                        });
                        self.isObserving = false;
                    }).observe(Polymer.dom(this).node, {subtree: true, childList: true, characterData: true});

                    this.set('_modalStatus', this._modalStatuses.CLOSED);
                    this._setupPickers();
                },

                showReplaceAction: function() {
                    return this.item.usingDefaultTeam || this.item.usingTeamByIssueType || this.item.usingParentTeam;
                },

                showRemoveAction: function() {
                    return this.item.teams.length > 1;
                },

                teamClasses: function() {
                    if (this.item.usingDefaultTeam)
                        return "default-team";
                    if (this.item.usingTeamByIssueType)
                        return "team-by-issue-type";
                    if (this.item.usingParentTeam)
                        return "parent-team";
                    return "";
                },

                titleForTeam: function(team) {
                    if (this.item.usingDefaultTeam)
                        return team.name + " is the default team for project " + this.item.project;
                    if (this.item.usingTeamByIssueType)
                        return team.name + " is the default team for issue type " + this.getIssueTypeName(this.item.type) + " on project " + this.item.project;
                    if (this.item.usingParentTeam)
                        return "Team " + team.name + " was inherited from parent issue " + this.item.parent;
                    return "";
                },

                addClassToInvalidTeam: function(item, assignee) {
                    if (this.isInvalidTeam(item, assignee)) {
                        return "invalid-assignee";
                    }
                    return "";
                },

                titleForAssignee: function(item, assignee) {
                    if (this.isInvalidTeam(item, assignee))
                        return "Assignee should be in one of these teams: " + item.teamNames.join(",");
                    return "";
                },

                _showAddTeamPicker: function(e) {
                    e.stopPropagation();
                    this._closeAllPickers();
                    this.$.teamSelector.open(this.$.addTeamButton);
                },

                _restoreDefaultTeams: function() {
                    this._issueAction(
                            'restoreDefaultTeams',
                            'restore teams in issue')
                },

                _showReplaceTeamPicker: function(e) {
                    e.stopPropagation();
                    if (!this.showReplaceAction())
                        return;

                    this._closeAllPickers();

                    var team = e.model.get("team");
                    var label = this.$$(".labelForTeam_0");
                    $(this.$.teamSelector).css("width", $(label).width()+40)
                    this.$.teamSelector.open(label, team.id);
                },

                pickerForAddAssignee: function(e) {
                    e.stopPropagation();
                    this._closeAllPickers();
                    this.$.pickerForAddAssignee.open();
                },
                
                _showClassOfServicePicker: function(e) {
                    e.stopPropagation();
                    this._closeAllPickers();
                    this.$.classOfServiceSelector.open();
                    var label = this.$$('#class-of-service-value')
                    $(this.$.classOfServiceSelector).css("width", $(label).width()+40)
                    this.$.classOfServiceSelector.open(label);
                },

                _addOrReplaceTeam: function(e) {
                    var teamPicker = e.target;
                    var selectedTeamId = teamPicker.selected;

                    if (!selectedTeamId) {
                        teamPicker.close();
                        return;
                    }

                    var action;
                    if (teamPicker.idOfteamToReplace) // replace
                        action = this._issueAction(
                            'replaceTeamInIssue',
                            'replace team in issue',
                            {teamToReplace: teamPicker.idOfteamToReplace, replacementTeam: selectedTeamId})
                    else //add
                        action = this._issueAction('addTeamToIssue', 'add team to issue', {id: selectedTeamId})

                    action.always(function() {
                        teamPicker.close();
                    })
                },

                _addAssignee: function(e) {
                    var userPicker = e.target;
                    var selectedUsername = userPicker.selected;

                    if (!selectedUsername) {
                        userPicker.close();
                        return;
                    }
                    this._issueAction('addAssigneeToIssue', 'add assignee to issue', {username: selectedUsername})
                        .always(function() {
                            userPicker.close();
                        })
                },

                _changeClassOfService: function(e) {
                    var classOfServicePicker = e.target,
                        selectedClassOfService = classOfServicePicker.selected;

                    if (!selectedClassOfService) {
                        classOfServicePicker.close();
                        return;
                    }

                    this._issueAction('saveClassOfService', 'change class of service of issue' + this.item.issueKey, selectedClassOfService)
                        .always(function() {
                            classOfServicePicker.close();
                        })
                },

                _setupPickers: function() {
                    // setup replacement pickers
                    var self = this;
                    // setup add new team picker
                    var teamPicker = this.$.teamSelector;
                    teamPicker.open = function(label, id) {
                        teamPicker.clear()
                        $(teamPicker).show();
                        teamPicker.focus()
                        teamPicker.label = $(label);
                        teamPicker.label.hide();
                        teamPicker.idOfteamToReplace = id;
                    }
                    teamPicker.close = function() {
                        $(teamPicker).hide();
                        if (teamPicker.label)
                            teamPicker.label.show();
                        teamPicker.idOfteamToReplace = null;
                    }

                    // setup the assignee picker
                    var userPicker = self.$.pickerForAddAssignee;
                    userPicker.open = function() {
                        userPicker.clear();
                        $(userPicker).show();
                        userPicker.focus()
                        $(self.$.addAssigneeButton).hide();
                        if (self.isNotAssignedToMySelf(self.item))
                        $(self.$$("#assignToMe")).hide();
                    }
                    userPicker.close = function() {
                        $(userPicker).hide();
                        $(self.$.addAssigneeButton).show();
                        if (self.isNotAssignedToMySelf(self.item))
                        $(self.$$("#assignToMe")).show();
                    }

                    var classOfServicePicker = self.$.classOfServiceSelector;
                    classOfServicePicker.open = function(label) {
                        classOfServicePicker.clear();
                        $(classOfServicePicker).show();
                        classOfServicePicker.focus();
                        classOfServicePicker.label = $(label);
                        classOfServicePicker.label.hide();
                    }
                    classOfServicePicker.close = function() {
                        $(classOfServicePicker).hide();
                        if (classOfServicePicker.label)
                            classOfServicePicker.label.show();
                    }
                },
               
                _closePicker: function(e) {
                     e.target.close();
                 },

                _closeAllPickers: function() {
                    var pickers = Polymer.dom(this.root).querySelectorAll(".people-picker");
                    pickers.forEach(function(tp) {
                        tp.close();
                    });
                },

                _toggleShowMoreOrLess: function() {
                    if (!this.descriptionExpanded)
                       this._expandDescription();
                    else
                       this._collapseDescription();

                    this.descriptionExpanded = !this.descriptionExpanded;
                },

                _openDescriptionEditMode: function() {
                     this.descriptionIsEditable = true;
                },
                
                _closeDescriptionEditMode: function() {
                     this.descriptionIsEditable = false;
                },
                
                _saveIssueDescription: function() {
                    var self = this;

                    this._issueAction("saveDescription", "save description " + this.item.issueKey, this.item.description)
                    .fail(function(){
                            self.descriptionIsEditable = true;
                     }).done(function() {
                         self._closeDescriptionEditMode();
                     });
                },
                

                _expandDescription: function() {
                    var element = this.$$(".description-row");
                    $(element).animate({"max-height" : element.scrollHeight}, 500)
                    $(".descriptionShowMore iron-icon").addClass("upsideDown")
                    this.showMoreOrLess = "Show Less"
                },

                _collapseDescription: function() {
                    var element = this.$$(".description-row");
                    $(element).animate({"max-height" : '20vh'}, 500);
                    $(".descriptionShowMore iron-icon").removeClass("upsideDown")
                    this.showMoreOrLess = "Show More"
                },

                parseMinutesToHours: function (minutes) {
                    if (minutes === 0)
                        return '0h';

                    var hours = Math.floor(minutes / 60);
                    var min = minutes % 60;

                    return (hours > 0 ? hours + 'h ' : '') + (min > 0 ? min + 'm' : '');
                },

                timetrackingCallback: function (timetracking) {
                    this.timetracking = timetracking;
                    this.shouldShowTimetracking = true;
                    this.timetrackingLabel = this.parseMinutesToHours(this.timetracking.timeSpentMinutes)
                },

                subtaskHeader: function (item) {
                    if (this.item.type === ISSUETYPE_ID.DEMANDA)
                        return "Tasks";
                    else
                        return "Sub-tasks";
                },

                hideTimetracking: function () {
                    this.shouldShowTimetracking = false;
                },

                getUriImage: function (issue) {
                    return 'images/projetos/logo_' + issue.project.toLowerCase() + '.png';
                },

                _addMeAsAssignee: function (e) {
                    try {
                        e.target.close();
                    }catch(ex){}
                    var self = this;
                    var issueBefore = this.item;
                    var issue = clone(this.item);

                    var requestBody = issue.issueKey;
                    $.ajax({
                        url: '/ws/issues/addMeAsAssignee',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: requestBody,
                        success: function (issueFromServer) {
                            self._setIssueLocalStateAndFireUpdated(issueFromServer, false, null, 'UPDATED');
                            if(self._isOpenedAndIsTheSameIssue(issueFromServer.issueKey))
                                self.setCard(issueFromServer);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            var responseMessage = jqXhr.responseJSON.message;
                            var toastMessage = 'Assign to me on issue "' + issueBefore.issueKey + '" failed: ' + responseMessage;
                            self._setIssueLocalStateAndFireUpdated(issueBefore, false, toastMessage, 'UPDATED');

                            if(self._isOpenedAndIsTheSameIssue(issueBefore.issueKey)) {
                                self.item = issueBefore;
                            } else {
                                taskboard.showIssueError(self. issueBefore.issueKey, toastMessage);
                            }
                        },
                        async: true
                    });
                },

                _canToggleBlockState: function(state) {
                    if (!this.item)
                        return false;
                    if (this.item.blocked)
                        return this.canBlock;
                    return this.canUnblock;
                },

                _toggleBlockUnblock: function() {
                    if (this.blocked)
                        return this.block();

                    return this.unblock();
                },

                block: function () {
                    var self = this;
                    var callback = function(issue) {
                        self._setIssueLocalState(self.item, true, null);
                        self._issueAction("block-task", "block issue " + issue.issueKey, issue.lastBlockReason)
                            .fail(function(){
                                self.blocked = false;
                            });
                    };

                    var fields = [{id: "lastBlockReason",
                        name: taskboard.getFieldName({fieldId: CUSTOMFIELD.LAST_BLOCK_REASON}),
                        type: TYPE_FIELD.TEXTAREA}];

                    self.$.fieldsRequiredDialog.openDialog(fields, "Block", self.item, callback);
                },

                blockCancelled: function() {
                    this.blocked = false;
                },

                unblock: function () {
                    this._issueAction("unblock-task", "unblock issue " + this.item.issueKey, {})
                        .fail(function(){
                            self.blocked = true;
                        });
                },

                requestTransition: function (e) {
                    var self =  this;
                    var issue = self.item;
                    var transition = this.getTransitionById(e.target.dataset.transitionId);
                    var status = taskboard.getStatus(e.target.dataset.transitionToStatusId);
                    var fieldsTransitions = self.getFieldsTransitions(transition);
                    var text = "Do you want to execute transition \""+ transition.name + "\"?";
                    var callback = function(issue, fieldValuesRequired){
                        if(self.isResolutionRequired(transition))
                            self.doResolution(transition, issue, status, fieldValuesRequired);
                        else
                            self.doTransition(transition, issue, status, fieldValuesRequired);
                    }
                    if(self.showFieldsRequiredDialog)
                        self.$.transitionRequiredDialog.openDialog(fieldsTransitions, transition.name, issue, callback);
                    else
                        self.$.confirmModal.openDialog("Confirmation", text, callback);
                    self.showFieldsRequiredDialog = false;
                },

                getFieldsTransitions: function(transition){
                    var self = this;
                    var fieldsTransitions = [];
                    if (transition){
                        Object.values(transition.fields).forEach(function(field ) {
                            if(field.required && !isFieldNameEquals(field.name, taskboard.getResolutionFieldName())){
                                self.showFieldsRequiredDialog = true;
                                fieldsTransitions.push(field);
                            }
                        })
                        if(TRANSITION_REQUIRED_COMMENT.indexOf(transition.name) !== -1)
                           self.showFieldsRequiredDialog = true;
                    }
                    return fieldsTransitions;
                },

                isResolutionRequired: function (transition) {
                    if (!transition)
                        return false;
                    var found = Object.values(transition.fields).find(
                        function(field) { return field.required && isFieldNameEquals(field.name, taskboard.getResolutionFieldName()) }
                        );
                    return found !== undefined;
                },

                doTransition: function (transition, issue, status, fieldValuesRequired) {
                    var self = this;
                    if(!issue)
                        issue = this.item;
                    var issueBeforeTransition = clone(issue);
                    var params = {issueKey: issue.issueKey, transitionId: transition.id, fields: fieldValuesRequired};

                    $.ajax({
                        url: '/ws/issues/transition',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(params),
                        success: function (issueFromServer, textStatus, jQxhr) {
                            self._setIssueLocalStateAndFireUpdated(issueFromServer, false, null, 'TRANSITION');
                            if(self._isOpenedAndIsTheSameIssue(issueFromServer.issueKey))
                                self.setCard(issueFromServer);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            var responseMessage = jqXhr.responseJSON.message;
                            var toastMessage = 'Transition of issue "' + issueBeforeTransition.issueKey + '" to "' + transition.name +  '" failed: ' + responseMessage;
                            self._setIssueLocalStateAndFireUpdated(issueBeforeTransition, false, toastMessage, 'TRANSITION');

                            if(self._isOpenedAndIsTheSameIssue(issueBeforeTransition.issueKey))
                                self.setCard(issueBeforeTransition);

                            taskboard.showIssueError(self, issueBeforeTransition.issueKey, toastMessage);
                        },
                        async: true
                    });

                    this.close();
                    issue.status = status.id;
                    this._setIssueLocalStateAndFireUpdated(clone(issue), true, null, 'TRANSITION');
                },

                doResolution: function (transition, issue, status, fieldValuesRequired) {
                    var self = this;
                    $.ajax({
                        url: '/ws/issues/resolutions/'+transition.name,
                        type: 'get',
                        success: function (data, textStatus, jQxhr) {
                            copyProperties(fieldValuesRequired, {resolution: data});
                            self.doTransition(transition, issue, status, fieldValuesRequired);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(jqXhr);
                            self.set('errorMessage', jqXhr.responseJSON.message);
                        },
                    });
                },

                opendialog: function (item) {
                    var self = this;
                    this.closeIfOpenedDialog();
                    this.isObserving = false;
                    this.setCard(item);
                    this.classOfServiceOptions = [];
                    this.classOfServicePickerIsVisible = false;
                    
                    this.getFieldOptions(item, 'Class of Service', function(data, el) {
                        self.classOfServiceOptions = data;
                        
                        if (data.length > 1) {
                            self.classOfServicePickerIsVisible = true;
                        }
                    });
                    
                    this.$.modal.open();
                    this.isOpen = true;

                    this.showMoreOrLess      = "Show More";
                    this.descriptionExpanded = false;
                    this.set('descriptionTooLong', false);
                    $(this.$$(".tshirt-bubble")).hide();
                    var self = this;
                    
                    if (this.canHaveSubtasks) {
                        this._collapseDescription();
                        setTimeout(function() {
                            var element = self.$$(".description-row");
                            if (element.offsetHeight < element.scrollHeight ||
                                element.offsetWidth < element.scrollWidth)
                                self.set('descriptionTooLong', true);
                            else
                                self.set('descriptionTooLong', false);
                        },10)
                    }
                    else setTimeout(function() {
                       self._expandDescription();
                    },10);

                },

                _resizeModal: function() {
                    this.$.modal.notifyResize();
                },

                setCard: function(item) {

                    this.hasSubtasks = (typeof item.subtasks !== undefined && item.subtasks.length > 0);
                    this.canHaveSubtasks = item.feature || item.demand;

                    this.canBlock = !item.blocked && !item.completed;
                    this.canUnblock = item.blocked && !item.completed;
                    this.issueChangeStateClass = '';
                    this.issueDeleteStateClass = '';
                    this.updatedIssue = null;
                    this.item = item;
                    this.blocked = this.item.blocked;
                    if(!this.isUpdating) {
                        var self = this;
                        $.ajax({
                            url: '/ws/issue-detail/' + self.item.issueKey + "?timezone="+ taskboard.getTimeZoneIdFromBrowser() +"&onlyVisible="+false,
                            type: 'get',
                            tryCount : 0,
                            retryLimit : 3,
                            timeout: 5000,
                            success: function (data, textStatus, jQxhr) {
                                self.cycleTime = data.cycleTime === null ? null : data.cycleTime.toFixed(2);
                                self.transitions = data.transitions;
                                self.timetrackingCallback(data.jiraTimeTracking);
                            },
                            error: function (jqXhr, textStatus, errorThrown) {
                                if (textStatus == 'timeout') {
                                    this.tryCount++;
                                    if (this.tryCount <= this.retryLimit) {
                                        console.debug('Timeout error. Trying again...');
                                        $.ajax(this);
                                        return;
                                    }
                                    console.error('Timeout exceeded trying to get issue details');
                                }
                                self.hideTimetracking();
                                console.error('Error during remote proccess. ' + jqXhr);
                                self.set('errorMessage', jqXhr.responseJSON.message);
                            }
                        });
                    }

                    this._updateIssueLocalState();
                },
                
                getFieldOptions: function(item , fieldName, callback) {
                    var self = this,
                        fieldOptions = [];

                    $.ajax({
                        url: '/ws/issues/project-metadata?projectKey=' + item.projectKey,
                        type: 'get',
                        success: function (data, textStatus, jQxhr) {
                            var fieldsFromIssueType,
                                selectedIssueType = data.issuetypes.filter(function(issuetype) {
                                    return (issuetype.id === item.type); 
                                });
                            
      
                            fieldFromIssueType = selectedIssueType['0'].fields.filter(function(field) {
                                return (field.name == fieldName);
                            });
                            
                            fieldOptions = fieldFromIssueType['0'] ? fieldFromIssueType['0'].allowedValues : fieldOptions
                            callback.apply(null, [fieldOptions]);
                            return fieldOptions;
                        },
                        error: function (jqXhr, textStatus, errorThrown){
                            console.log(errorThrown);
                        }
                    });
                },

                getDescriptionClass: function() {
                    var classes = "";
                    if (this.canHaveSubtasks)
                        classes += " description-row--collapsed";
                    if (!this.item.description)
                        classes += " description-row-no-description"
                    return classes;
                },

                isInvalidTeam: function(item,assignee) {
                    return item.mismatchingUsers.indexOf(assignee.name) !== -1;
                },

                determineTeamSectionClass: function(item) {
                    return item.teams.length > 0?"":"hidden-section";
                },

                hasMultipleTShirtSizes: function(item) {
                    return item.subtasksTshirtSizes.length > 1;
                },

                getDescription: function (issue) {
                    return issue.description ? jira2md.to_markdown(issue.description) : 'No description';
                },

                hasRecords: function (records) {
                    return records && records.length > 0;
                },

                isNotAssignedToMySelf: function(item) {
                    return item.assignees.map(function(a){return a.name}).indexOf(taskboard.getLoggedUser().name) === -1;
                },

                _showTShirtBubble: function(e) {
                    var bb = $(this.$$(".tshirt-bubble"));
                    var offset = ($(".subtitle--slot2").outerHeight()+bb.outerHeight())/2+5 + $(this.$$(".leftPanel")).scrollTop();
                    bb.css("margin-top", "-"+offset+"px")
                    bb.show();

                    var arrow = $(this.$$(".tshirt-bubble-arrow"));
                    arrow.css("top", "50%")

                    // adjust bubble and arrow position in case it goes partially offscreen
                    var windowBottom = $(window).scrollTop()+$(window).height()-10;
                    var bubbleBottom = bb.offset().top+bb.outerHeight();
                    if (bubbleBottom > windowBottom) {
                        var delta = bubbleBottom-windowBottom;
                        arrow.css("top", arrow.offset().top+delta-bb.offset().top);
                        offset += delta;
                        bb.css("margin-top", "-"+offset+"px")
                    }

                    if (e) e.stopPropagation();
                },

                _closeTShirtBubble: function() {
                    var bb = $(this.$$(".tshirt-bubble"));
                    bb.hide();
                },

                openJira: function (event) {
                    event.stopPropagation();
                    window.open(taskboard.urlJira + '/browse/' + this.item.issueKey, '_blank');
                },

                changeCard: function (event) {
                    var issueKey = event.target.getAttribute('data-issue-key');
                    navigatorService.openCard(issueKey);
                },

                _afterOpen: function() {
                    this.set('_modalStatus', this._modalStatuses.OPENED);
                },

                close: function(){
                    this._beforeClose();
                    this.$.modal.close();
                    this._afterClose();
                    navigatorService.resetUrlWithouLoad();
                },

                closeIfOpenedDialog: function(){
                    if(this.isOpen)
                        this.close();
                },

                _beforeClose: function () {
                    this.isOpen = false;
                    this.isObserving = false;
                },

                _afterClose: function () {
                    this.timetracking = {};
                    this.transitions = [];
                    this.showFieldsRequiredDialog = false;

                    this.shouldShowTimetracking = true;
                    this.hasSubtasks = true;

                    this.isUpdating = false;
                    this.errorMessage = null;
                    this.set('_modalStatus', this._modalStatuses.CLOSED);
                },

                getIssueTypeName: function(issueTypeId) {
                    return taskboard.getIssueTypeName(issueTypeId);
                },

                getIssueTypeImage: function(issue) {
                    return issue.typeIconUri;
                },
                
                transitionList: function() {
                    var r = [];
                    r.push({name: taskboard.getStatusName(this.item.status), order: this.item.statusOrder})
                    for(var t in this.transitions ) {
                        r.push(this.transitions[t])
                    }
                    return r.sort(function(a,b) {
                        return a.order - b.order;
                    });
                },

                updateIssue: function(event, data) {
                    if (!this.isOpen)
                        return;

                    if (data.source === 'client')
                        return;

                    if (this.item != null && data.issue.issueKey !== this.item.issueKey)
                        return;

                    this.isObserving = true;
                    this.set('updatedIssue', data.issue);
                    if (data.eventType === 'DELETED') {
                        this.set('issueDeleteStateClass', 'visible-glasspane');
                        this.set('issueChangeStateClass', '');
                        return;
                    }
                    this.set('issueDeleteStateClass', '');
                    this.set('issueChangeStateClass', 'visible-glasspane');
                },

                refreshIfUpdated: function() {
                    if (this.updatedIssue && this._isOpenedAndIsTheSameIssue(this.updatedIssue.issueKey))
                        this.setCard(this.updatedIssue);
                },

                getTransitionById: function(transitionId) {
                    return this.transitions.find( function(transition) { return transition.id == transitionId} );
                },

                _closeErrorMessage: function() {
                    this._setIssueLocalState(this.item, this.isUpdating, null);
                    this.fire("iron-signal", {name:"close-issue-error-message", data: this.item.issueKey });
                },

                _setIssueLocalStateAndFireUpdated: function(issue, isUpdating, errorMessage, eventType) {
                    this._setIssueLocalState(issue, isUpdating, errorMessage);
                    console.log("issue-detail: updated issue: " + issue.issueKey + " -- " +issue.stateHash)
                    taskboard.fireIssueUpdated('client', this, issue, eventType);
                },

                _setIssueLocalState: function(issue, isUpdating, errorMessage) {
                    if( this.localStates.issues[issue.issueKey] ) {
                        this.set('localStates.issues.' + issue.issueKey + '.isUpdating', isUpdating);
                        this.set('localStates.issues.' + issue.issueKey + '.errorMessage', errorMessage);
                    } else {
                        var issueLocalState = new IssueLocalStateBuilder(issue.issueKey).isUpdating(isUpdating).errorMessage(errorMessage).build();
                        this.set('localStates.issues.' + issueLocalState.getIssueKey(), issueLocalState);
                    }
                },

                _updateIssueLocalState: function() {
                    if (!this.item)
                        return;
                    var isUpdating = false;
                    var errorMessage = null;

                    var issueLocalState = this.localStates.issues[this.item.issueKey];
                    if (issueLocalState) {
                        isUpdating = issueLocalState.isUpdating;
                        errorMessage = issueLocalState.errorMessage;
                    }

                    var step = taskboard.getIssueStep(this.item);
                    if (step !== null) {
                        var stepLocalState = this.localStates.steps[step.id];
                        if (stepLocalState)
                            isUpdating = isUpdating || stepLocalState.isUpdating;
                    }

                    this.set('isUpdating', isUpdating);
                    this.set('errorMessage', errorMessage);
                },

                _isOpenedAndIsTheSameIssue: function(issueKey) {
                    return this.isOpen && (this.item && this.item.issueKey == issueKey);
                },
                
                removeTeam: function(e) {
                    var teamId = e.model.get("team.id")
                    this._issueAction('removeTeamFromIssue', 'remove team from issue', {id: teamId})
                },
                
                _removeAssignee: function(e) {
                    var username = e.model.get("assignee.name")
                    this._issueAction('removeAssigneeFromIssue', 'remove assignee from issue', {username: username})
                },
                
                _issueAction: function(action, actionName, data) {
                    var source = this;
                    this._setIssueLocalState(this.item, true, null);
                    return $.ajax({
                            url: '/ws/issues/'+action+'/'+source.item.issueKey,
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: (typeof data === 'object') ? JSON.stringify(data) : data
                        })
                        .done(function(issueFromServer) {
                            source._setIssueLocalStateAndFireUpdated(issueFromServer, false, null, 'UPDATED');
                            if(source._isOpenedAndIsTheSameIssue(issueFromServer.issueKey))
                                source.setCard(issueFromServer);
                        })
                        .fail(function (jqXhr) {
                            var errorMessage = "";
                            if (jqXhr.responseJSON)
                                errorMessage = jqXhr.responseJSON.message;
                            taskboard.showIssueError(source, source.item.issueKey, "Failed to "+ actionName + ". Error " + errorMessage);
                            source._setIssueLocalState(source.item, false, errorMessage);
                        });
                },

                _cardTapped: function () {
                    this._closeTShirtBubble();
                    this._closeAllPickers();
                },

                _stopPropagation: function (e) {
                    e.stopPropagation();
                },

                _shouldShowCycleTime: function(cycleTime) {
                    return cycleTime !== null;
                }
            });
        })();
    </script>

</dom-module>
