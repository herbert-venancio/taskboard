<!--
  [LICENSE]
  Taskboard
  - - -
  Copyright (C) 2015 - 2016 Objective Solutions
  - - -
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<link rel="import" href="progress-bar.html">

<dom-module id="sizing-import">

    <template>

        <style>
            :host {
                display: block;
            }

            .sizingimport-modal {
                width: 700px;
            }

            #modal {
                background: white;
                min-width: 300px;
                min-height: 360px;
                max-height: calc(100% - 20px);
                overflow-y: auto;
                margin: 0;
                display: block;
                font-family: inherit;
            }

            .card-custom {
                background: transparent;
                width: 100%;
                min-height: 360px;
                padding: 20px;
                margin: 0;
            }

            .half-column {
            }

            .card-header-custom {
                width: 100%;
                margin-bottom: 20px;
                font-size: 24px;
                display: flex;
            }

            .card-header-info {
                flex: 1;
            }

            .card-header-breadcrumb {
                font-size: 15px;
            }

            .sub-header {
                line-height: normal;
                margin-bottom: 5px;
                font-size: 13px;
                font-weight: 600;
            }

            .content-row {
                display: flex;
                margin-top: 10px;
            }

            .content-row:first-child {
                margin-top: 0;
            }

            paper-button {
                margin-bottom: 12px;
            }

            paper-button paper-icon-button {
                width: 25px;
                height: 25px;
                padding: 0;
                margin: 0 5px 0 0;
            }

            .card-header-buttons {
                padding: 0;
                margin-left: auto;
            }

            paper-material, paper-button {
                box-shadow: none !important;
            }

            paper-button[toggles] {
                transition: all 0.3s;
            }

            paper-button[toggles][active] {
                background-color: rgba(0, 0, 0, 0.25);
            }

            paper-button[toggles][active].colorful {
                background-color: rgba(66, 133, 244, 0.25);
            }

            paper-button[toggles][active][raised].colorful {
                background-color: rgba(66, 133, 244, 0.75);
            }

            .error-message {
                margin-top: 10px;
            }

            .buttonClose {
                min-width: auto;
                display: inline;
                padding: 0;
                margin: 0;
            }

            .custom-footer {
                position: absolute;
                bottom: 20px;
            }

            .custom-footer-buttons {
                display: flex;
                margin-left: -5px;
                margin-right: -5px;
            }

            .custom-footer-buttons paper-button {
                padding: 5px 10px;
                margin: 0 5px;
                text-transform: none;
                text-align: center;
            }

            paper-spinner[aria-hidden=true] {
                display: none;
            }

            .scroll {
                padding: 10px;
                overflow: auto;
                overflow-x: hidden;
                max-height: 150px;
                width: 100%;
                background-color: white;
            }

            .modal-title {
                font-size: 25px;
            }

            .steps {
            }

            .steps__numbers {
                display: flex;
                justify-content: space-around;

                margin-bottom: 30px;
                position: relative;
            }

            .steps__numbers:before {
                content: "";
                display: block;

                border-radius: 10px;
                background: #CCC;
                width: 100%;
                height: 2px;
                top: 50%;
                margin-top: -1px;
                left: 0;
                position: absolute;
                z-index: -1;
            }

            .steps__number {
                display: flex;
                align-items: center;
                justify-content: center;

                border-radius: 50%;
                background: #999;
                width: 40px;
                height: 40px;
                font-size: 20px;
                color: #FFF;
            }

            .steps__number.active {
                background: #000;
            }

            .steps__content {
            }

            .step__title {
                margin: 0 0 20px 0;
            }

            .step__text {
                margin-bottom: 30px;
            }

            .step__content {
                display: flex;
                flex-direction: column;
                justify-content: center;

                min-height: 130px;
            }

            .step__buttons {
                display: flex;
                margin-top: 20px;
            }

            .step__content paper-button {
                margin: 0 0 0 20px
            }

            .step__content paper-button:first-child {
                margin-left: 0;
            }

            .step__buttons paper-button {
                margin: 0 0 0 20px
            }

            .step__buttons paper-button:first-child {
                margin-left: 0;
            }

            .step__buttons-left {
            }

            .step__buttons-right {
                margin-left: auto;
            }

            .step__buttons-left + .step__buttons-right {
                padding-left: 30px;
            }

            .sizing__confirmation-border {
                width: 100%;
                overflow: hidden;
                border: 1px solid #E5E5E5;
                border-top: none;
                border-radius: 0 0 4px 4px;
                padding: 16px;
            }

            .sizing__confirmation-wrapper {
                width: 100%;
                height: 235px;
                overflow-x: auto;
            }

            .sizing__confirmation th, .sizing__confirmation td {
                min-width: 80px;
                max-width: 150px;
            }

            paper-button.colorful {
                color: #4285f4;
            }

            paper-button[raised].colorful {
                background: #4285f4;
                color: #fff;
            }

            paper-button[raised] {
                background: #CCC;
                color: #000;
            }

            #loading {
                display: flex;
                align-items: center;
                justify-content: center;

                background: rgba(0,0,0,0.6);
                width: 0;
                height: 0;
                margin: 0;
                left: 0;
                top: 0;
                position: absolute;
                z-index: 1000;
                opacity: 0;
                overflow: hidden;

                -webkit-transition: opacity 0.4s ease-in-out;
                -moz-transition: opacity 0.4s ease-in-out;
                -ms-transition: opacity 0.4s ease-in-out;
                -o-transition: opacity 0.4s ease-in-out;
                transition: opacity 0.4s ease-in-out;
            }

            #loading.active {
                width: 100%;
                height: 100%;
                opacity: 1;
            }

        </style>

        <iron-signals on-iron-signal-sizing-import-status="statusOfStepFour"></iron-signals>
        <paper-dialog class="sizingimport-modal" id="modal" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop modal>
            <paper-card class="card-custom">

                <div class="card-header-custom">
                    <div class="card-header-info">
                        <div class="card-header-breadcrumb">
                            <span class="modal-title">
                                Import Sizing
                            </span>
                        </div>
                    </div>
                </div>

                <div class="content-box">

                    <div class="steps">

                        <div id="stepsNumbers" class="steps__numbers">
                            <a class$="{{getStepNumberClass(stepNumber, 1)}}">1</a>
                            <a class$="{{getStepNumberClass(stepNumber, 2)}}">2</a>
                            <a class$="{{getStepNumberClass(stepNumber, 3)}}">3</a>
                            <a class$="{{getStepNumberClass(stepNumber, 4)}}">4</a>
                        </div><!-- .steps__numbers -->

                        <div class="steps__content">

                            <template is="dom-if" if="{{isStepActive(stepNumber, 1)}}" restamp="true">
                                <h3 class="step__title">
                                    Checking authorization and spreadsheet format
                                </h3>

                                <div class="tb-text step__text">
                                    <p>We need to know what project you want to use. Besides that, we will request your authorization to access your Google Spreadsheet</p>
                                </div>

                                <form class="tb-form">

                                    <div class="step__content">
                                        <div class="tb-form__row">
                                            <label for="projectkey">Select the project:</label>
                                            <select id="projectkey" name="projectkey" value="{{projectKey::input}}">
                                                <template is="dom-repeat" items="{{projects}}" as="project">
                                                    <option value="{{project.key}}">
                                                        {{project.name}}
                                                    </option>
                                                </template>
                                            </select>
                                        </div>
                                        <div class="tb-form__row">
                                            <label for="spreadsheetUrl">Insert the URL of your Google Spreadsheet:</label>
                                            <input placeholder="ex.: https://docs.google.com/spreadsheets/d/abcdegfhijklmnop/" type="url" id="spreadsheetUrl" name="spreadsheetUrl" value="{{spreadsheetUrl::input}}" />
                                            <div class="alert alert-info">If the Google authorization screen says “This app isn't verified”,
                                                select <strong>Advanced</strong>, select <strong>Go to ____ (unsafe)</strong> and follow the instructions.
                                                See <a target="blank" href="https://support.google.com/accounts/answer/7455163">this page</a> for more information.</div>
                                        </div>
                                    </div><!-- .step__content -->

                                    <template is="dom-if" if="{{_errorMessage}}">
                                        <div class="error-message alert alert-danger">
                                            <strong id="error-message">{{_errorMessage}}</strong>
                                            <div id="error-detail">{{_errorDetail}}</div>
                                        </div>
                                    </template>

                                    <div class="step__buttons">
                                        <div class="step__buttons-left">
                                            <paper-button class="sizing__cancel" raised on-tap="cancelImportation" title="Cancel importation">
                                                Cancel
                                            </paper-button>
                                        </div>
                                        <div class="step__buttons-right">
                                            <paper-button class="sizing__submit colorful" raised on-tap="submitStepOne" title="Next">
                                                Next
                                            </paper-button>
                                        </div>
                                    </div><!-- .step__buttons -->

                                </form><!-- .tb-form -->

                            </template><!-- .step -->

                            <template is="dom-if" if="{{isStepActive(stepNumber, 2)}}" restamp="true">

                                <h3 class="step__title">
                                    Google Spreadsheet Mapping
                                </h3>

                                <div class="tb-text step__text">
                                    <p>
                                        If you didn't modify the Sizing Spreadsheet, skip this step clicking the "Next" button.<br>
                                        Otherwise, click on "Advanced Mapping".
                                    </p>
                                </div>

                                <div class="step__content">

                                    <div class="tb-accordion">

                                        <a class="tb-accordion__button sizing__open-advanced-mapping" on-tap="collapseCustomFieldsMappingTap">
                                            <iron-icon id="collapseCustomFieldsMappingToggleIcon" class="tb-accordion__button-icon icon-small" icon="chevron-right"></iron-icon>
                                            <span class="tb-accordion__button-text">Advanced Mapping</span>
                                        </a>

                                        <iron-collapse class="tb-accordion__collapse" id="collapseCustomFieldsMapping">

                                            <div class="tb-text step__text">
                                                <p>
                                                    Please, associate the task types with the columns of the spreadsheet ("Scope" sheet).
                                                    {{ fixedFieldsFormattedText }}
                                                </p>
                                            </div>

                                            <form class="tb-form sizing__advanced-mapping">

                                                <table class="tb-table tb-table--scroll">
                                                    <thead class="tb-table__header">
                                                        <tr>
                                                            <th class="tb-table__column tb-table__column--field tb-table__column--header">Task type</th>
                                                            <th class="tb-table__column tb-table__column--column tb-table__column--header">Column</th>
                                                        </tr>
                                                    </thead><!-- .tb-table__header -->
                                                    <tbody id="jira-issuefields" class="tb-table__content">
                                                        <template is="dom-repeat" items="{{customFields}}" as="field" index-as="fieldIndex">
                                                            <tr class="jira-issuefield">
                                                                <td class="tb-table__column tb-table__column--field">
                                                                        {{field.name}} {{getTextIfIsRequired(field)}}
                                                                </td>
                                                                <td class="step__mapp tb-table__column tb-table__column--column">
                                                                    <input class$="tb-text--align-center sizing__mapping-column {{getCustomFieldClass(field)}}"
                                                                        value="{{field.columnLetter::input}}"
                                                                        data-index$="{{fieldIndex}}"
                                                                        placeholder="Not used" type="text"
                                                                        on-keydown="onInputColumnValue" on-focus="onFocusColumnValue" on-click="onFocusColumnValue" />
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody><!-- .tb-table__content -->
                                                </table><!-- .tb-table -->

                                            </form><!-- .tb-form -->

                                        </iron-collapse>

                                    </div><!-- .tb-accordion -->

                                </div><!-- .step__content -->

                                <template is="dom-if" if="{{_errorMessage}}">
                                    <div class="error-message alert alert-danger">
                                        <strong id="error-message">{{_errorMessage}}</strong>
                                        <div id="error-detail">{{_errorDetail}}</div>
                                    </div>
                                </template>

                                <div class="step__buttons">
                                    <div class="step__buttons-left">
                                        <paper-button class="sizing__cancel" raised on-tap="cancelImportation" title="Cancel importation">
                                            Cancel
                                        </paper-button>
                                    </div>
                                    <div class="step__buttons-right">
                                        <paper-button class="sizing__back" raised on-tap="previousStep" title="Previous step">
                                            Back
                                        </paper-button>
                                        <paper-button class="sizing__submit colorful" raised on-tap="submitStepTwo" title="Next">
                                            Next
                                        </paper-button>
                                    </div>
                                </div><!-- .step__buttons -->

                            </template><!-- .step -->

                            <template is="dom-if" if="{{isStepActive(stepNumber, 3)}}" restamp="true">

                                <h3 class="step__title">
                                    Confirmation
                                </h3>

                                <div class="tb-text step__text">
                                    <p>These are a sample data of the spreadsheet. You can step back to some adjustments. Click on the "Confirm" button to start the importation.</p>
                                </div>

                                <form class="tb-form">

                                    <div class="step__content">

                                        <ul class="tb-tabs">
                                            <template is="dom-repeat" items="[[sheets]]" as="sheet">
                                                <li class$="tb-tab [[_getSheetActiveClass(sheet, selectedSheet)]]">
                                                    <a class="tb-tab-link tb-truncate" data-sheet="[[sheet]]" on-tap="_selectSheet"
                                                       title="[[sheet.sheetTitle]] (Total: [[sheet.totalLinesCount]])">
                                                        [[sheet.sheetTitle]] (Total: [[sheet.totalLinesCount]])
                                                    </a>
                                                </li>
                                            </template>
                                        </ul><!-- .tb-tabs -->

                                        <div class="sizing__confirmation-border">
                                            <div class="sizing__confirmation-wrapper">

                                                <table class="tb-table sizing__confirmation">
                                                    <thead class="tb-table__header">
                                                        <tr>
                                                            <template is="dom-repeat" items="[[selectedSheet.headers]]" as="header">
                                                                <th class="tb-table__column tb-table__column--header sizing__confirmation-header-value">{{removeFromString(header, " TSize")}}</th>
                                                            </template>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="jira-issuefields" class="tb-table__content">
                                                        <template  is="dom-repeat" items="[[selectedSheet.rows]]" as="row">
                                                            <tr class="sizing__confirmation-row">
                                                                <template is="dom-repeat" items="[[row]]" as="rowItem">
                                                                    <td class="tb-table__column tb-truncate sizing__confirmation-row-value">
                                                                        {{rowItem}}
                                                                    </td>
                                                                </template>
                                                            </tr>
                                                        </template>
                                                    </tbody><!-- .tb-table__content -->
                                                </table><!-- .tb-table -->

                                            </div><!-- .sizing__confirmation-wrapper -->
                                        </div><!-- .sizing__confirmation-border -->

                                    </div><!-- .step__content -->

                                    <div class="step__buttons">
                                        <div class="step__buttons-left">
                                            <paper-button class="sizing__cancel" raised on-tap="cancelImportation" title="Cancel importation">
                                                Cancel
                                            </paper-button>
                                        </div>
                                        <div class="step__buttons-right">
                                            <paper-button class="sizing__back" raised on-tap="previousStep" title="Previous step">
                                                Back
                                            </paper-button>
                                            <paper-button class="sizing__submit colorful" raised on-tap="submitStepThree" title="Confirm">
                                                Confirm and start to import
                                            </paper-button>
                                        </div>
                                    </div><!-- .step__buttons -->

                                </form><!-- .tb-form -->

                            </template><!-- .step -->

                            <template is="dom-if" if="{{isStepActive(stepNumber, 4)}}" restamp="true">
                                <h3 class="step__title">
                                    Import Progress
                                </h3>

                                <div class="step__content">
                                    <progress-bar class="importation-progress" percent="{{statusPercent}}" message="{{statusMessage}}"></progress-bar>
                                </div><!-- .step__content -->

                                <template is="dom-if" if="{{isImportationCompleted}}">
                                    <table class="tb-table sizing__importation--summary">
                                        <thead class="tb-table__header">
                                            <tr>
                                                <th class="tb-table__column tb-table__column--label"></th>
                                                <template is="dom-repeat" items="[[sheetsStatus]]" as="sheet">
                                                    <th class="tb-table__column tb-table__column--header">[[sheet.sheetTitle]]</th>
                                                </template>
                                            </tr>
                                        </thead><!-- .tb-table__header -->
                                        <tbody class="tb-table__content">
                                            <tr>
                                                <th class="tb-table__column tb-table__column--label">Total lines</th>
                                                <template is="dom-repeat" items="[[sheetsStatus]]" as="sheet">
                                                    <td class="tb-table__column tb-truncate">[[sheet.totalLines]]</td>
                                                </template>
                                            </tr>
                                            <tr>
                                                <th class="tb-table__column tb-table__column--label">Lines to import</th>
                                                <template is="dom-repeat" items="[[sheetsStatus]]" as="sheet">
                                                    <td class="tb-table__column tb-truncate">[[sheet.linesToImport]]</td>
                                                </template>
                                            </tr>
                                            <tr>
                                                <th class="tb-table__column tb-table__column--label">Imported lines</th>
                                                <template is="dom-repeat" items="[[sheetsStatus]]" as="sheet">
                                                    <td class="tb-table__column tb-truncate">[[sheet.importedLines]]</td>
                                                </template>
                                            </tr>
                                            <tr>
                                                <th class="tb-table__column tb-table__column--label">Failed lines</th>
                                                <template is="dom-repeat" items="[[sheetsStatus]]" as="sheet">
                                                    <td class="tb-table__column tb-truncate">[[sheet.failedLines]]</td>
                                                </template>
                                            </tr>
                                        </tbody><!-- .tb-table__content -->
                                    </table><!-- .tb-table -->

                                    <div class="step__buttons">
                                        <div class="step__buttons-left">
                                        </div>
                                        <div class="step__buttons-right">
                                            <paper-button class="sizing__return-to-taskboard" raised on-tap="cancelImportation" title="Back to Taskboard">
                                                Close
                                            </paper-button>
                                            <paper-button class="sizing__open-spreadsheet colorful" raised on-tap="openGoogleSpreadsheet" title="Check the Google Spreadsheet">
                                                Check the Spreadsheet
                                            </paper-button>
                                        </div>
                                    </div><!-- .step__buttons -->
                                </template>

                            </template><!-- .step -->

                        </div><!-- .steps__content -->

                    </div><!-- .steps -->

                </div><!-- .content-box -->

            </paper-card>
            <div id="loading">
                <paper-spinner active alt="Loading..."></paper-spinner>
            </div>
        </paper-dialog>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'sizing-import',

                properties: {
                    projects: {
                        type: Array
                    },
                    projectKey: {
                        type: String
                    },
                    needsGoogleAuthorizarion: {
                        type: Boolean
                    },
                    spreadsheetUrl: {
                        type: String
                    },
                    spreadsheetId: {
                        type: String
                    },
                    stepNumber: {
                        type: Number
                    },
                    customFields: {
                        type: Array
                    },
                    fixedFields: {
                        type: Array
                    },
                    fixedFieldsFormattedText: {
                        type: String
                    },
                    lastColumn: {
                        type: String
                    },
                    sheets: {
                        type: Array
                    },
                    statusPercent: {
                        type: Number,
                        value: 0
                    },
                    statusMessage: {
                        type: String
                    },
                    isImportationCompleted: {
                        type: Boolean
                    },
                    _isOpen: {
                        type: Boolean
                    },
                    _errorMessage: String,
                    _errorDetail: String
                },

                ready: function() {
                    window.addEventListener("hashchange", this.openByHash.bind(this));
                    this.openByHash();
                },

                openByHash: function() {
                    var hash = window.location.hash;
                    if (hash === "#/sizing-import/open")
                        this.opendialog();
                    else if (this._isOpen) {
                        this.$.modal.close();
                        this._isOpen = false;
                    }
                },

                opendialog: function () {
                    this._isOpen = true;
                    this.initStepOne();
                },

                initStepOne: function() {
                    var self = this;

                    this.stepNumber = 1;
                    this.projects = [];
                    this.projectKey = null;

                    this.spreadsheetUrl = '';
                    this.spreadsheetId = '';
                    this.clearErrorMessage();

                    this.loadingEnable();
                    this.$.modal.open();

                    this.loadInitialData()
                        .then(function() {
	                        if (self.needsGoogleAuthorizarion)
	                            return self.initGoogleAuth();
	                    })
                        .fail(function() {
                            self.setErrorMessage('Failed to load initial data.');
                        })
                        .always(function() {
                            self.goToStep(1);
                            self.loadingDisable();
                        });
                },

                loadInitialData: function() {
                    var self = this;

                    return $.getJSON('ws/sizing-import/initial-data/')
                        .done(function(data) { 
                            self.needsGoogleAuthorizarion = data.needsGoogleAuthorizarion;
                            self.projects = data.projects;
                            self.projectKey = self.projects[0] ? self.projects[0].key : null;
                        });
                },

                initGoogleAuth: function() {
                    var result = $.Deferred();
                    gapi.load('client:auth2', function() {
                        gapi.client
                            .init({
                                'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                                'clientId': GOOGLE_CLIENT_ID,
                                'scope': 'https://www.googleapis.com/auth/spreadsheets'
                            })
                            .then(result.resolve, result.reject);
                    });
                    return result.promise();
                },

                submitStepOne: function() {
                    this.clearErrorMessage();

                    if (!this.spreadsheetUrl) {
                        this.setErrorMessage("Please, inform the Google Spreadsheet URL to import.");
                        return;
                    }

                    this.spreadsheetId = this.getGoogleIdFromUrl(this.spreadsheetUrl);
                    if (!this.spreadsheetId) {
                        this.setErrorMessage("Invalid Google Spreadsheet URL. Please, try another.");
                        return;
                    }

                    this.loadingEnable();

                    if (this.needsGoogleAuthorizarion) {
                        this.requestGoogleAuthorization();
                    } else {
                        this.validateStepOne();
                    }
                },

                validateStepOne: function() {
                    var self = this;
                    $.ajax({
                        url: 'ws/sizing-import/validation/' + self.projectKey + '/' + self.spreadsheetId,
                        success: function (data) {
                            if (data.success) {
                                self.initStepTwo();

                            } else {
                                self.setErrorMessage(data.errorMessage, data.errorDetail);
                                self.loadingDisable();
                            }
                        },
                        error: function (error) {
                            if (error.status === 403) {
                                if (error.responseJSON.exception.match(/.*\$GoogleApiPermissionDeniedException$/)) {
                                    self.needsGoogleAuthorizarion = true;
                                    self.initGoogleAuth();
                                    self.setErrorMessage("Previous stored user or selected user doesn't have access to the document. Try again and choose another user");
                                }
                                else {
                                    self.setErrorMessage(error.responseJSON.message);
                                }
                            }
                            else
                                self.setErrorMessage('Internal server error');
                            self.loadingDisable();
                        }
                    });
                },

                requestGoogleAuthorization: function() {
                    var self = this;

                    gapi.auth2.getAuthInstance().grantOfflineAccess({prompt: 'consent'})
                        .then(function(authResult) {
                            $.ajax({
                                    url: 'ws/sizing-import/google-authorization/', 
                                    type: 'POST',
                                    contentType: 'application/octet-stream; charset=utf-8',
                                    data: authResult.code
                                })
                                .done(function() {
                                    self.needsGoogleAuthorizarion = false;
                                    self.validateStepOne();
                                });
                        }, function() {
                            self.setErrorMessage('Google authorization failed.');
                            self.loadingDisable();
                        });
                },

                initStepTwo: function() {
                    var self = this;
                    $.getJSON('ws/sizing-import/spreadsheet-details/' + this.projectKey + '/' + this.spreadsheetId + '/')
                        .done(function(data) {
                            self.showStepTwo(data);
                        })
                        .fail(function() {
                            self.setErrorMessage('Internal server error');
                            self.loadingDisable();
                        });
                },

                showStepTwo: function(response) {
                    this.lastColumn = response.lastColumn;

                    var customFields = response.dynamicColumns
                        .map( columnsMapping => {
                            return {
                                columnId: columnsMapping.columnId,
                                name: columnsMapping.name.replace(" TSize", ""),
                                required: columnsMapping.required,
                                columnLetter: columnsMapping.defaultColumnLetter
                            }
                        });

                    this.customFields = _(customFields).chain()
                        .sortBy('name')
                        .reverse()
                        .sortBy('required')
                        .reverse()
                        .value();

                    this.fixedFields = response.staticColumns;
                    this.fixedFieldsFormattedText = this.fixedFieldsTextFormatter();
                    this.goToStep(2);
                    this.loadingDisable();
                },

                submitStepTwo: function() {

                    var self = this;

                    this.clearErrorMessage();

                    if (this.hasRequiredCustomFieldsWithoutColumn()) {
                        this.setErrorMessage("All required fields must have columns associated.");
                        return;
                    }

                    if (this.hasRepeatedColumnLetter()) {
                        this.setErrorMessage("Column repeated.");
                        return;
                    }

                    this.loadingEnable();

                    var data = this.getNoBlankCustomFields();

                    $.ajax({
                        url: 'ws/sizing-import/confirmation/' + self.projectKey + '/' + self.spreadsheetId,
                        type: 'POST',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        success: function (data) {
                            self.showStepThree(data);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            self.setErrorMessage(errorThrown);
                            self.loadingDisable();
                        },
                        async: true
                    });
                },

                showStepThree: function(response) {
                    var sheets = [ response.scopePreview ];
                    if (response.costPreview)
                        sheets = sheets.concat(response.costPreview);
                    this.set('sheets', sheets);
                    this.set('selectedSheet', response.scopePreview);
                    this.goToStep(3);
                    this.loadingDisable();
                },

                submitStepThree: function() {
                    var self = this;

                    var data = this.customFields
                        .filter( function(c) {
                            return !self.isInvalidValue(c.columnLetter)
                        })
                        .map( function(c) {
                            return {
                                columnId: c.columnId,
                                columnLetter: c.columnLetter
                            }
                        });

                    $.ajax({
                        url: 'ws/sizing-import/import/' + self.projectKey + '/' + self.spreadsheetId,
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function () {},
                        error: function (jqXhr, textStatus, errorThrown) {
                            self.set('statusMessage', jqXhr.responseJSON.message);
                            self.set('isImportationCompleted', true);
                        }
                    });

                    //Show step 4 while the import is in progress. Status is updated via websocket.
                    self.showStepFour();
                },

                showStepFour: function() {
                    this.isImportationCompleted = false;
                    this.statusPercent = 0;
                    this.statusMessage = "Starting to import...";
                    this.sheetsStatus = null;

                    this.goToStep(4);
                },

                statusOfStepFour: function(event) {
                    if (this.isImportationCompleted)
                        return;

                    var status = event.detail.status;
                    var currentSheetStatus = status.currentSheetStatus;

                    if (!currentSheetStatus) {
                        this.statusMessage = "Importation started...";
                        return;
                    }

                    var totalImported = status.importedLines + status.failedLines;
                    var completed = totalImported == status.totalLines;
                    var totalSheetImported = currentSheetStatus.importedLines + currentSheetStatus.failedLines;

                    this.isImportationCompleted = completed;
                    this.statusPercent = status.totalLines == 0 ? 100 : Math.round((totalImported / status.totalLines) * 100);
                    this.statusMessage = "Importing " + currentSheetStatus.sheetTitle + " sheet... " +
                        totalSheetImported + " of " + currentSheetStatus.linesToImport + " " + (currentSheetStatus.linesToImport == 1 ? "line" : "lines") + "...";

                    if (completed) {
                        if (status.failedLines > 0)
                            this.statusMessage = "Importation completed with failed lines. Please fix the errors and import the spreadsheet again.";
                        else
                            this.statusMessage = "Importation completed successfully.";
                        this.sheetsStatus = status.sheetsStatus;
                        this.$.modal.notifyResize();
                    }
                },

                getNoBlankCustomFields: function() {
                    return this.customFields
                    .filter( c => {
                        return !this.isInvalidValue(c.columnLetter)
                    })
                    .map( c => {
                        return {
                            columnId: c.columnId,
                            columnLetter: c.columnLetter
                        }
                    });
                },

                openGoogleSpreadsheet: function() {
                    event.stopPropagation();
                    var win = window.open(this.spreadsheetUrl);
                    this.close();
                },

                collapseCustomFieldsMappingTap: function (e) {
                    var collapse = this.$$('#collapseCustomFieldsMapping');
                    var collapseIcon = this.$$('#collapseCustomFieldsMappingToggleIcon');

                    collapse.toggle();
                    collapseIcon.icon = collapse.opened ? 'expand-more' : 'chevron-right';
                },

                getCustomFieldClass: function(field) {
                    return field.required ? "is-required" : "";
                },

                getTextIfIsRequired: function(field) {
                    return field.required ? " (required)" : "";
                },

                fixedFieldsTextFormatter: function() {
                    var fieldsText = "";
                    var firstIndex = 0;
                    if (this.fixedFields) {
                        var lastIndex = this.fixedFields.length - 1;
                        for (var i = 0; i < this.fixedFields.length; i++) {
                            if (i > firstIndex && i < lastIndex)
                                fieldsText += ', ';
                            else if (i == lastIndex)
                                fieldsText += ', and ';
                            fieldsText += this.fixedFields[i].name + ' (' + this.fixedFields[i].columnLetter + ')';
                        }
                    }
                    return "It's not allowed to change columns of " + fieldsText + ".";
                },

                removeFromString: function(originalString, stringToRemove) {
                    return originalString.replace(stringToRemove, "");
                },

                onFocusColumnValue: function(e) {
                    setTimeout(function(){ e.target.selectionStart = e.target.selectionEnd = e.target.value.length; }, 0);
                },

                onInputColumnValue: function(e) {
                    var index = e.target.dataset.index;
                    var newValue = e.target.value + e.key.toUpperCase();
                    if (e.key == "Tab") {
                        return
                    } else if (e.key == "Backspace") {
                        newValue = this.customFields[index].columnLetter.slice(0, -1);
                        this.customFields[index].columnLetter = newValue;
                        e.target.value = newValue;
                    } else if ( this.isLetter(e.key) && this.letterToColumn(newValue) <= this.letterToColumn(this.lastColumn)) {
                        e.target.value = newValue;
                        this.customFields[index].columnLetter = newValue;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                },

                isLetter: function(value) {
                    return /^[a-zA-Z]*$/g.test(value);
                },

                hasRequiredCustomFieldsWithoutColumn: function() {
                    for (var i = 0; i < this.customFields.length; i++) {
                        if (this.customFields[i].required && this.isInvalidValue(this.customFields[i].columnLetter))
                            return true;
                    }
                    return false;
                },

                hasRepeatedColumnLetter: function() {
                    var fixedColumnLetters = _.map(this.fixedFields, "columnLetter");
                    var noBlankCustomFields = _.map(this.getNoBlankCustomFields(), "columnLetter");
                    var allColumnLetters = fixedColumnLetters.concat(noBlankCustomFields);
                    return allColumnLetters.length != _.uniq(allColumnLetters).length;
                },

                isInvalidValue: function(value) {
                    return value === null || value == "" || value === undefined;
                },

                loadingEnable: function() {
                    var loadingBox = this.$.loading;
                    loadingBox.classList.add('active');
                },

                loadingDisable: function() {
                    var loadingBox = this.$.loading;
                    loadingBox.classList.remove('active');
                },

                cancelImportation: function() {
                    this.close();
                },

                close: function() {
                    navigatorService.resetUrlWithoutLoadForceHashChange()
                },

                letterToColumn: function(letter) {
                    var column = 0;
                    var length = letter.length;
                    for (var i = 0; i < length; i++) {
                        column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
                    }
                    return column;
                },

                getGoogleIdFromUrl: function (url) {
                    var idFromUrl = url.match(/[-\w]{25,}/);
                    if (idFromUrl)
                        return idFromUrl[0];
                    else
                        return null;
                },

                setErrorMessage: function(message, detail) {
                    this._errorMessage = message;
                    this._errorDetail = detail || '';
                },

                clearErrorMessage: function() {
                    this.setErrorMessage('');
                },

                isStepActive: function(currentStep, step) {
                    return currentStep == step;
                },

                getStepNumberClass: function(currentStep, step) {
                    var classes = 'steps__number';

                    if (currentStep == step)
                        classes += ' active';

                    return classes;
                },

                previousStep: function() {
                    this.clearErrorMessage();
                    this.stepNumber--;
                    this.goToStep(this.stepNumber);
                },

                nextStep: function() {
                    this.stepNumber++;
                    this.goToStep(this.stepNumber);
                },

                goToStep: function(stepNumber) {
                    this.stepNumber = stepNumber;
                    this.$.modal.notifyResize();
                },

                _getSheetActiveClass: function(currentSheet, selectedSheet) {
                    if (currentSheet.sheetTitle === selectedSheet.sheetTitle)
                        return 'active';
                    return '';
                },

                _selectSheet: function(event) {
                    this.set('selectedSheet', event.target.dataSheet);
                }
            });
        })();
    </script>

</dom-module>
