<dom-module id="widget-progress-chart">

    <template>

        <style>
            #progress-chart {
                height: 100%;
                width: 100%;
            }
        </style>

        <widget-wrap title="Progress Chart" is-ready="{{isReady}}" 
                error-message="{{errorMessage}}" highcharts-chart="{{chart}}">
            <div id="progress-chart" class="tb-chart"></div>
        </widget-wrap>

        
    </template>

    <script>
        (function () {
            Polymer({
                is: 'widget-progress-chart',

                properties: {
                    selectedProjectKey: {
                        type: String,
                        observer: '_onProjectSelected'
                    },
                    isReady: {
                        type: Boolean,
                        value: false
                    },
                    errorMessage: {
                        type: String
                    },
                    chart: {
                        type: Object
                    },
                    isVisible: {
                        type: Boolean
                    },
                    _plotData: {
                        type: Object
                    },
                    _isPlotDataUpdated: {
                        type: Boolean
                    }
                },

                observers: [
                    '_createChart(_isPlotDataUpdated, isVisible)'
                ],

                _onProjectSelected: function (newSelectedProjectKey, previousSelectedProjectKey) {
                    if (newSelectedProjectKey === previousSelectedProjectKey) {
                        return;
                    }
                    this._fetchData(newSelectedProjectKey);
                },

                _fetchData: function (selectedProjectKey) {
                    this.reset();
                    var url = `/api/projects/${selectedProjectKey}/followup/progress?timezone=${taskboard.getTimeZoneIdFromBrowser()}`;
                    this.xhr = $.getJSON(url);
                    this.xhr.done((data) => {
                        this._prepareData(data);
                    });
                    
                    this.xhr.fail((error) => {
                        this.errorMessage = error.responseText;
                    });
                },

                _prepareData: function(data){
                    const formatPlotData = (type, array, color) => {
                        const serie = {
                            name: type,
                            data: [],
                            color: color
                        };
                        array.forEach(d => {
                            serie.data.push({
                                x  : getDateFromIso(d.date),
                                y  : d.progress * 100
                            });
                        });
                        return serie;
                    };
            
                    var graphData = [];
                    
                    graphData.push(formatPlotData('Actual', data.actual, dcUtils.colors.DONE));
                    graphData.push(formatPlotData('Projection', data.actualProjection, dcUtils.colors.DONE_PROJECTION));
                    graphData.push(formatPlotData('Expected', data.expected, dcUtils.colors.EXPECTED));

                    this.startDate = getDateFromIso(data.startingDate);
                    this.endDate = getDateFromIso(data.endingDate);
                    
                    this._plotData = graphData;
                    this._isPlotDataUpdated = true;
                },

                _createChart: function (isPlotDataUpdated, isVisible) {
                    if (!isVisible || !isPlotDataUpdated) {
                        return;
                    }
                    this._resetChart();
                    const builder = new ProgressChartBuilder('progress-chart', this.startDate, this.endDate)
                        .withChartType('spline')
                        .withSeriesData(this._plotData);
                    this.chart = builder.build();
                    dcDateRangeChartsService.registerHighchartsChart(this.chart);
                    dcDateRangeChartsService.applySelection(this.chart);

                },

                ready: function () {
                    this._createChartOptions();
                },

                _createChartOptions: function() {
                    this.options = new WidgetOptionsBuilder(this)
                        .withCustomOption(
                            new WidgetOptionBuilder()
                                .withIcon('taskboard-icons:dashboard-filter')
                                .withTitle('Chart filters')
                                .withOnTap(() => this.$.modal.open())
                                .withHidden(false)
                                .build()
                        )
                        .withFullscreen()
                        .build();
                    this._isPlotDataUpdated = false;
                    this.isReady = true;
                },

                reset: function () {
                    this.isReady = false;
                    this.errorMessage = '';
                    if (this.xhr) {
                        this.xhr.abort();
                        this.xhr = null;
                    }
                    this._resetChart();
                },

                _resetChart: function () {
                    if (this.chart) {
                        dcDateRangeChartsService.deregisterHighchartsChart(this.chart);
                        this.chart.destroy();
                        this.chart = null;
                    }
                }
            });
        })();
    </script>
</dom-module>